name: Playwright CI 

on:
  workflow_dispatch:  # Manual trigger ONLY

jobs:
  playwright-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ­ Install Playwright browsers
      run: npx playwright install --with-deps chromium

    - name: ğŸ§ª Run Playwright tests
      id: run-tests
      run: |
        echo "ğŸš€ Running Playwright tests..."
        
        # Run tests with HTML reporter (creates playwright-report/)
        npx playwright test --config=playwright.ci.config.js \
          --reporter=html,line \
          2>&1 | tee playwright-test-output.txt
        
        # Save exit code
        TEST_EXIT_CODE=$?
        echo "TEST_EXIT_CODE=$TEST_EXIT_CODE" >> $GITHUB_ENV
        
        # Extract basic metrics
        if [ -f "playwright-test-output.txt" ]; then
          TOTAL_TESTS=$(grep -o "[0-9]\+ tests" playwright-test-output.txt | head -1 | grep -o "[0-9]\+" || echo "0")
          PASSED_TESTS=$(grep -o "[0-9]\+ passed" playwright-test-output.txt | head -1 | grep -o "[0-9]\+" || echo "0")
          FAILED_TESTS=$(grep -o "[0-9]\+ failed" playwright-test-output.txt | head -1 | grep -o "[0-9]\+" || echo "0")
          SKIPPED_TESTS=$(grep -o "[0-9]\+ skipped" playwright-test-output.txt | head -1 | grep -o "[0-9]\+" || echo "0")
          DURATION=$(grep -o "in [0-9]\+[\.][0-9]\+s" playwright-test-output.txt | tail -1 | sed 's/in //' || echo "0s")
          
          echo "TOTAL_TESTS=$TOTAL_TESTS" >> $GITHUB_ENV
          echo "PASSED_TESTS=$PASSED_TESTS" >> $GITHUB_ENV
          echo "FAILED_TESTS=$FAILED_TESTS" >> $GITHUB_ENV
          echo "SKIPPED_TESTS=$SKIPPED_TESTS" >> $GITHUB_ENV
          echo "DURATION=$DURATION" >> $GITHUB_ENV
          
          # Calculate pass rate
          if [ "$TOTAL_TESTS" -gt 0 ]; then
            PASS_RATE=$((PASSED_TESTS * 100 / TOTAL_TESTS))
            echo "PASS_RATE=$PASS_RATE" >> $GITHUB_ENV
          else
            echo "PASS_RATE=0" >> $GITHUB_ENV
          fi
        fi

    - name: ğŸ“Š Create Clean Test Report
      if: always()
      run: |
        echo "# ğŸ­ Playwright Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Overall status
        if [ "${TEST_EXIT_CODE}" = "0" ]; then
          echo "## âœ… ALL TESTS PASSED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Great job! All UI tests completed successfully.**" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ TESTS FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**${FAILED_TESTS} test(s) need attention.**" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Simple metrics table
        echo "### ğŸ“Š Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Result |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Total Tests** | ${TOTAL_TESTS} |" >> $GITHUB_STEP_SUMMARY
        echo "| **âœ… Passed** | ${PASSED_TESTS} |" >> $GITHUB_STEP_SUMMARY
        echo "| **âŒ Failed** | ${FAILED_TESTS} |" >> $GITHUB_STEP_SUMMARY
        echo "| **â­ï¸ Skipped** | ${SKIPPED_TESTS} |" >> $GITHUB_STEP_SUMMARY
        echo "| **â±ï¸ Duration** | ${DURATION} |" >> $GITHUB_STEP_SUMMARY
        
        if [ "$TOTAL_TESTS" -gt 0 ]; then
          echo "| **ğŸ“ˆ Pass Rate** | ${PASS_RATE}% |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Show failing tests (if any)
        if [ "$FAILED_TESTS" -gt 0 ] && [ -f "playwright-test-output.txt" ]; then
          echo "### ğŸ” Failing Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get failed test names
          FAILED_TEST_NAMES=$(grep -A1 "âœ—" playwright-test-output.txt | grep -v "âœ—" | grep -v "^--$" | head -10)
          if [ -n "$FAILED_TEST_NAMES" ]; then
            echo "**These tests failed:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$FAILED_TEST_NAMES" | while read -r line; do
              echo "- âŒ $line" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "Check the HTML report for detailed failure information." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Simple recommendations
        echo "### ğŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${TEST_EXIT_CODE}" = "0" ]; then
          echo "âœ… **Ready to proceed** - All tests are passing." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the HTML report for detailed results" >> $GITHUB_STEP_SUMMARY
          echo "2. Continue with your deployment process" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Action Required** - Some tests need fixing." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Download the HTML report** (includes screenshots & traces)" >> $GITHUB_STEP_SUMMARY
          echo "2. **Fix the ${FAILED_TESTS} failing test(s)**" >> $GITHUB_STEP_SUMMARY
          echo "3. **Re-run tests** after fixes" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Report location
        echo "### ğŸ“ Reports Available" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Download these artifacts for detailed analysis:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **ğŸ“Š HTML Report**: Interactive test results with screenshots" >> $GITHUB_STEP_SUMMARY
        echo "- **ğŸ“¸ Test Artifacts**: Screenshots, videos, traces for debugging" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Final status
        echo "---" >> $GITHUB_STEP_SUMMARY
        if [ "${TEST_EXIT_CODE}" = "0" ]; then
          echo "*âœ… Tests completed successfully*" >> $GITHUB_STEP_SUMMARY
        else
          echo "*âŒ ${FAILED_TESTS} test(s) failed - review required*" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ğŸ“¤ Upload Playwright report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: |
          playwright-report/
          playwright-test-output.txt
        retention-days: 7

    - name: ğŸ“¤ Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: test-results/
        retention-days: 7

    - name: ğŸš¨ Fail if tests failed
      if: failure()
      run: |
        echo "âŒ ${FAILED_TESTS} Playwright test(s) failed"
        echo "Download the HTML report for debugging details"
        exit 1
