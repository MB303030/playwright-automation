name: Test Runner main

on:
  workflow_call:
    inputs:
      test_type:
        required: true
        type: string
      test_suite:
        required: true
        type: string
      browser:
        required: true
        type: string
      environment:
        required: true
        type: string
      custom_tags:
        required: false
        type: string
        default: ''
      priority:
        required: true
        type: string
      test_path:
        required: true
        type: string
      run_id:
        required: true
        type: string

env:
  CI: true
  FORCE_COLOR: 1

jobs:
  run-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      total_tests: ${{ steps.extract-stats.outputs.TOTAL_TESTS }}
      passed_tests: ${{ steps.extract-stats.outputs.PASSED_TESTS }}
      failed_tests: ${{ steps.extract-stats.outputs.FAILED_TESTS }}
      skipped_tests: ${{ steps.extract-stats.outputs.SKIPPED_TESTS }}
      duration: ${{ steps.execute.outputs.DURATION }}
      success_rate: ${{ steps.extract-stats.outputs.SUCCESS_RATE }}
      exit_code: ${{ steps.execute.outputs.EXIT_CODE }}
      browser_icon: ${{ steps.extract-stats.outputs.BROWSER_ICON }}
      browser_color: ${{ steps.extract-stats.outputs.BROWSER_COLOR }}
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci
          npx playwright install --with-deps ${{ inputs.browser }}
      
      - name: ðŸƒ Execute Tests
        id: execute
        run: |
          START_TIME=$(date +%s)
          
          CMD="npx playwright test \"${{ inputs.test_path }}\""
          CMD="$CMD --project=${{ inputs.browser }}"
          CMD="$CMD --reporter=html,allure-playwright"
          CMD="$CMD --retries=2"
          CMD="$CMD --timeout=90000"
          CMD="$CMD --trace=on"
          CMD="$CMD --video=on"
          CMD="$CMD --screenshot=on"
          
          if [ -n "${{ inputs.custom_tags }}" ]; then
            TAGS=$(echo "${{ inputs.custom_tags }}" | tr ',' '|')
            CMD="$CMD --grep=\"($TAGS)\""
          fi
          
          if [ "${{ inputs.test_type }}" = "Performance Tests" ]; then
            CMD="$CMD --workers=1"
          elif [ "${{ inputs.test_type }}" = "Mobile Tests" ]; then
            CMD="$CMD --workers=2"
          else
            CMD="$CMD --workers=4"
          fi
          
          echo "ðŸš€ Running: $CMD"
          eval $CMD || true
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo "EXIT_CODE=$?" >> $GITHUB_OUTPUT
          echo "DURATION=$DURATION" >> $GITHUB_OUTPUT
      
      - name: ðŸ“Š Extract Test Statistics
        id: extract-stats
        if: always()
        run: |
          if [ -f "playwright-report/index.html" ]; then
            TOTAL_TESTS=$(grep -o '"total"[[:space:]]*:[[:space:]]*[0-9]*' playwright-report/index.html | head -1 | grep -o '[0-9]*' || echo "0")
            PASSED_TESTS=$(grep -o '"passed"[[:space:]]*:[[:space:]]*[0-9]*' playwright-report/index.html | head -1 | grep -o '[0-9]*' || echo "0")
            FAILED_TESTS=$(grep -o '"failed"[[:space:]]*:[[:space:]]*[0-9]*' playwright-report/index.html | head -1 | grep -o '[0-9]*' || echo "0")
            SKIPPED_TESTS=$(grep -o '"skipped"[[:space:]]*:[[:space:]]*[0-9]*' playwright-report/index.html | head -1 | grep -o '[0-9]*' || echo "0")
          else
            TOTAL_TESTS="0"
            PASSED_TESTS="0"
            FAILED_TESTS="0"
            SKIPPED_TESTS="0"
          fi
          
          if [ "$TOTAL_TESTS" -gt 0 ]; then
            SUCCESS_RATE=$((PASSED_TESTS * 100 / TOTAL_TESTS))
          else
            SUCCESS_RATE=0
          fi
          
          echo "TOTAL_TESTS=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "PASSED_TESTS=$PASSED_TESTS" >> $GITHUB_OUTPUT
          echo "FAILED_TESTS=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "SKIPPED_TESTS=$SKIPPED_TESTS" >> $GITHUB_OUTPUT
          echo "SUCCESS_RATE=$SUCCESS_RATE" >> $GITHUB_OUTPUT
      
      - name: ðŸ“¦ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: raw-results-${{ inputs.run_id }}
          path: |
            playwright-report/
            allure-results/
            test-results/
            trace/
          retention-days: 7
