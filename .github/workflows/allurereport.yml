name: Playwright CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual trigger

jobs:
  # Check Docker is available
  check-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Verify Docker installation
        run: |
          which docker || echo "‚ùå Docker not found"
          docker --version
          echo "‚úÖ Docker check complete"

  # Run Playwright tests with CI config
  playwright-tests:
    runs-on: ubuntu-latest
    needs: check-docker
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: üì¶ Install dependencies
      run: npm ci

    - name: üé≠ Install Playwright browsers
      run: npx playwright install --with-deps chromium

    - name: üîß List files for debugging
      run: |
        echo "Current directory:"
        pwd
        echo "Files in root:"
        ls -la
        echo "Config files:"
        ls -la playwright*.config.js || echo "No config files found"

    - name: üß™ Run Playwright tests (CI config)
      run: |
        echo "Running tests with CI config..."
        # Run with your CI-specific config
        npx playwright test --config=playwright.ci.config.js
      continue-on-error: true  # Continue even if tests fail

    - name: üîß Generate Allure HTML report
      if: always()
      run: |
        echo "Generating Allure HTML report..."
        
        # Install Allure CLI
        npm install -g allure-commandline
        
        # Check if allure-results exists
        if [ -d "allure-results" ] && [ "$(ls -A allure-results)" ]; then
          echo "üìä Generating Allure HTML report from allure-results..."
          allure generate allure-results -o allure-report --clean
          
          if [ -d "allure-report" ]; then
            echo "‚úÖ Allure HTML report generated"
            ls -la allure-report/
          else
            echo "‚ùå Failed to generate Allure HTML report"
          fi
        else
          echo "‚ö†Ô∏è No allure-results found, creating empty report..."
          mkdir -p allure-report
          cat > allure-report/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head><title>Allure Report - No Data</title></head>
          <body>
            <h1>‚ö†Ô∏è Allure Report</h1>
            <p>No test results data available.</p>
            <p>Allure results were not generated by the test run.</p>
          </body>
          </html>
          EOF
        fi

    - name: üìä Check generated reports
      run: |
        echo "Checking for generated reports..."
        echo "üìÅ Directory listing:"
        ls -la
        
        echo "üé≠ Playwright reports:"
        if [ -d "playwright-report" ]; then
          echo "Found playwright-report directory"
          echo "Size: $(du -sh playwright-report)"
        else
          echo "No playwright-report directory"
        fi
        
        echo "‚ú® Allure results:"
        if [ -d "allure-results" ]; then
          echo "Found allure-results directory"
          echo "Files: $(find allure-results -type f | wc -l)"
        else
          echo "No allure-results directory"
        fi
        
        echo "üìä Allure HTML report:"
        if [ -d "allure-report" ]; then
          echo "Found allure-report directory"
          echo "Size: $(du -sh allure-report)"
        else
          echo "No allure-report directory"
        fi
        
        echo "üì∏ Test artifacts:"
        if [ -d "test-results" ]; then
          echo "Found test-results directory"
          echo "Size: $(du -sh test-results)"
        else
          echo "No test-results directory"
        fi

    - name: üì§ Upload Playwright HTML report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-html-report
        path: playwright-report/
        retention-days: 7

    - name: üì§ Upload Allure HTML report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: allure-html-report
        path: allure-report/
        retention-days: 7

    - name: üì§ Upload Allure raw results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: allure-results
        path: allure-results/
        retention-days: 7

    - name: üì§ Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-artifacts
        path: |
          test-results/
        retention-days: 7

    - name: üìã Create job summary
      if: always()
      run: |
        echo "## üé≠ Playwright CI Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow:** [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### üìä Available Reports:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Report Type | Artifact Name | What's Inside |" >> $GITHUB_STEP_SUMMARY
        echo "|-------------|---------------|---------------|" >> $GITHUB_STEP_SUMMARY
        echo "| üé≠ **Playwright HTML** | `playwright-html-report` | Interactive HTML report with screenshots |" >> $GITHUB_STEP_SUMMARY
        echo "| üìä **Allure HTML** | `allure-html-report` | Full Allure report with trends & graphs |" >> $GITHUB_STEP_SUMMARY
        echo "| üìÅ **Allure Raw Data** | `allure-results` | Raw JSON/XML results for local processing |" >> $GITHUB_STEP_SUMMARY
        echo "| üì∏ **Test Artifacts** | `test-artifacts` | Screenshots, videos, traces |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### üîç How to view:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### 1. Playwright Report (Easiest):" >> $GITHUB_STEP_SUMMARY
        echo "1. Download `playwright-html-report` artifact" >> $GITHUB_STEP_SUMMARY
        echo "2. Extract ZIP" >> $GITHUB_STEP_SUMMARY
        echo "3. Open `index.html` in any browser" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### 2. Allure Report (Advanced):" >> $GITHUB_STEP_SUMMARY
        echo "1. Download `allure-html-report` artifact" >> $GITHUB_STEP_SUMMARY
        echo "2. Extract ZIP" >> $GITHUB_STEP_SUMMARY
        echo "3. Open `index.html` in any browser" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### 3. For Debugging:" >> $GITHUB_STEP_SUMMARY
        echo "- Download `test-artifacts` for screenshots/videos of failed tests" >> $GITHUB_STEP_SUMMARY
        echo "- Download `allure-results` to generate custom reports locally" >> $GITHUB_STEP_SUMMARY
