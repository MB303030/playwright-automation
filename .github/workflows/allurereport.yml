name: Allure report

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual trigger

jobs:
  # Check Docker is available
  check-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Verify Docker installation
        run: |
          which docker || echo "âŒ Docker not found"
          docker --version
          echo "âœ… Docker check complete"

  # Run Playwright tests with CI config
  playwright-tests:
    runs-on: ubuntu-latest
    needs: check-docker
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸŽ­ Install Playwright browsers
      run: npx playwright install --with-deps chromium

    - name: ðŸ§ª Run Playwright tests (CI config)
      run: |
        echo "Running tests with CI config..."
        # Run with your CI-specific config
        npx playwright test --config=playwright.ci.config.js
      continue-on-error: true  # Continue even if tests fail

    - name: ðŸ“Š Check generated reports
      run: |
        echo "Checking for generated reports..."
        echo "ðŸ“ Directory listing:"
        ls -la
        
        echo "ðŸŽ­ Playwright HTML report:"
        if [ -d "playwright-report" ]; then
          echo "âœ… Found playwright-report directory"
          ls -la playwright-report/
        else
          echo "âŒ No playwright-report directory"
        fi
        
        echo "âœ¨ Allure results:"
        if [ -d "allure-results" ]; then
          echo "âœ… Found allure-results directory"
          ls -la allure-results/
        else
          echo "âŒ No allure-results directory"
        fi
        
        echo "ðŸ“¸ Test artifacts:"
        if [ -d "test-results" ]; then
          echo "âœ… Found test-results directory"
          ls -la test-results/
        else
          echo "âŒ No test-results directory"
        fi

    - name: ðŸ“¤ Upload Playwright HTML report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-html-report
        path: playwright-report/
        retention-days: 7

    - name: ðŸ“¤ Upload Allure results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: allure-results
        path: allure-results/
        retention-days: 7

    - name: ðŸ“¤ Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-artifacts
        path: |
          test-results/
        retention-days: 7

    - name: ðŸ“‹ Create job summary
      if: always()
      run: |
        echo "## ðŸŽ­ Playwright CI Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow:** [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“Š Available Reports:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Report Type | Artifact Name | What's Inside |" >> $GITHUB_STEP_SUMMARY
        echo "|-------------|---------------|---------------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŽ­ **Playwright HTML Report** | `playwright-html-report` | Interactive HTML report with screenshots/videos |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“ **Allure Results** | `allure-results` | Raw results data for Allure reports |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“¸ **Test Artifacts** | `test-artifacts` | Screenshots, videos, traces from failed tests |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ” How to view reports:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### 1. ðŸŽ­ Playwright Report (Easiest - RECOMMENDED):" >> $GITHUB_STEP_SUMMARY
        echo "1. Download `playwright-html-report` artifact" >> $GITHUB_STEP_SUMMARY
        echo "2. Extract ZIP file" >> $GITHUB_STEP_SUMMARY
        echo "3. Open `index.html` in any browser" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### 2. ðŸ“Š Allure Report (Advanced):" >> $GITHUB_STEP_SUMMARY
        echo "1. Download `allure-results` artifact" >> $GITHUB_STEP_SUMMARY
        echo "2. Install Allure CLI: `npm install -g allure-commandline`" >> $GITHUB_STEP_SUMMARY
        echo "3. Generate report: `allure generate allure-results -o allure-report --clean`" >> $GITHUB_STEP_SUMMARY
        echo "4. Open report: `allure open allure-report`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### 3. ðŸ› For Debugging Failed Tests:" >> $GITHUB_STEP_SUMMARY
        echo "- Download `test-artifacts` for screenshots/videos of failed tests" >> $GITHUB_STEP_SUMMARY
