name: Professional Test Runner

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'ğŸ¯ What type of tests to run?'
        required: true
        type: choice
        options:
        - Web Tests
        - Mobile Tests
        - Performance Tests
        - All Tests
      test_suite:
        description: 'ğŸ“‚ Which test suite?'
        required: false
        type: choice
        options:
        - Smoke
        - Sanity
        - Regression
        - Negative
        - All
        default: 'All'
      browser:
        description: 'ğŸŒ Browser to use'
        required: true
        type: choice
        options:
        - chrome
        - firefox
        - webkit
        default: 'chrome'
      environment:
        description: 'ğŸ¢ Test environment'
        required: false
        type: choice
        options:
        - Development
        - Staging
        - Production
        - Custom
        default: 'Staging'
      custom_tags:
        description: 'ğŸ·ï¸ Custom tags (comma-separated, e.g., @smoke,@critical)'
        required: false
        default: ''
      priority:
        description: 'ğŸ¯ Test priority'
        required: false
        type: choice
        options:
        - P0-Critical
        - P1-High
        - P2-Medium
        - P3-Low
        default: 'P1-High'

env:
  CI: true
  FORCE_COLOR: 1

jobs:
  validate-and-trigger:
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.generate-id.outputs.run_id }}
      test_path: ${{ steps.config.outputs.TEST_PATH }}
    steps:
      - name: ğŸ†” Generate Run ID
        id: generate-id
        run: echo "run_id=run_$(date +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT

      - name: ğŸ¯ Configure Test Path
        id: config
        run: |
          # Determine test path
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          TEST_SUITE="${{ github.event.inputs.test_suite }}"
          
          if [ "$TEST_TYPE" = "Web Tests" ]; then
            BASE_PATH="./tests/web"
          elif [ "$TEST_TYPE" = "Mobile Tests" ]; then
            BASE_PATH="./tests/mobile"
          elif [ "$TEST_TYPE" = "Performance Tests" ]; then
            BASE_PATH="./tests/performance"
          else
            BASE_PATH="."
          fi
          
          if [ "$TEST_SUITE" != "All" ] && [ "$TEST_TYPE" != "Performance Tests" ] && [ "$TEST_TYPE" != "All Tests" ]; then
            TEST_PATH="$BASE_PATH/$TEST_SUITE"
          else
            TEST_PATH="$BASE_PATH"
          fi
          
          echo "TEST_PATH=$TEST_PATH" >> $GITHUB_OUTPUT
          echo "âœ… Test path configured: $TEST_PATH"

  execute-tests:
    needs: validate-and-trigger
    # FIXED: Make sure this matches your actual file name
    uses: ./.github/workflows/test-runner.yml
    with:
      test_type: ${{ github.event.inputs.test_type }}
      test_suite: ${{ github.event.inputs.test_suite }}
      browser: ${{ github.event.inputs.browser }}
      environment: ${{ github.event.inputs.environment }}
      custom_tags: ${{ github.event.inputs.custom_tags }}
      priority: ${{ github.event.inputs.priority }}
      test_path: ${{ needs.validate-and-trigger.outputs.test_path }}
      run_id: ${{ needs.validate-and-trigger.outputs.run_id }}
    secrets: inherit

  generate-reports:
    needs: execute-tests
    # FIXED: Make sure this matches your actual file name
    uses: ./.github/workflows/report-generator.yml
    with:
      test_type: ${{ github.event.inputs.test_type }}
      test_suite: ${{ github.event.inputs.test_suite }}
      browser: ${{ github.event.inputs.browser }}
      environment: ${{ github.event.inputs.environment }}
      priority: ${{ github.event.inputs.priority }}
      run_id: ${{ needs.validate-and-trigger.outputs.run_id }}
      total_tests: ${{ needs.execute-tests.outputs.total_tests }}
      passed_tests: ${{ needs.execute-tests.outputs.passed_tests }}
      failed_tests: ${{ needs.execute-tests.outputs.failed_tests }}
      skipped_tests: ${{ needs.execute-tests.outputs.skipped_tests }}
      duration: ${{ needs.execute-tests.outputs.duration }}
      success_rate: ${{ needs.execute-tests.outputs.success_rate }}
      exit_code: ${{ needs.execute-tests.outputs.exit_code }}
    secrets: inherit
