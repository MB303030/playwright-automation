name: main

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'ğŸ¯ What type of tests to run?'
        required: true
        type: choice
        options:
        - Web Tests
        - Mobile Tests
        - Performance Tests
        - Security Tests  # Added
        - All Tests
      test_suite:
        description: 'ğŸ“‚ Which test suite?'
        required: false
        type: choice
        options:
        - Smoke
        - Sanity
        - Regression
        - Negative
        - All
        default: 'All'
      browser:
        description: 'ğŸŒ Browser to use'
        required: true
        type: choice
        options:
        - chrome
        - firefox
        - webkit
        default: 'chrome'
      environment:
        description: 'ğŸ¢ Test environment'
        required: false
        type: choice
        options:
        - Development
        - Staging
        - Production
        - Custom
        default: 'Staging'
      custom_tags:
        description: 'ğŸ·ï¸ Custom tags (comma-separated, e.g., @smoke,@critical)'
        required: false
        default: ''
      priority:
        description: 'ğŸ¯ Test priority'
        required: false
        type: choice
        options:
        - P0-Critical
        - P1-High
        - P2-Medium
        - P3-Low
        default: 'P1-High'

jobs:
  validate_and_trigger:
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.generate_id.outputs.run_id }}
      test_path: ${{ steps.config.outputs.TEST_PATH }}
    steps:
      - name: ğŸ†” Generate Run ID
        id: generate_id
        run: echo "run_id=run_$(date +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT

      - name: ğŸ¯ Configure Test Path
        id: config
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          TEST_SUITE="${{ github.event.inputs.test_suite }}"
          
          if [ "$TEST_TYPE" = "Web Tests" ]; then
            BASE_PATH="./tests/web"
            if [ "$TEST_SUITE" = "Smoke" ]; then
              TEST_PATH="./tests/Smoke"
            elif [ "$TEST_SUITE" != "All" ]; then
              TEST_PATH="$BASE_PATH/$TEST_SUITE"
            else
              TEST_PATH="$BASE_PATH"
            fi
            
          elif [ "$TEST_TYPE" = "Mobile Tests" ]; then
            BASE_PATH="./tests/mobile"
            # Mobile doesn't have suite subdirectories
            TEST_PATH="$BASE_PATH"
            
          elif [ "$TEST_TYPE" = "Performance Tests" ]; then
            # Correct path based on your structure
            TEST_PATH="./tests/mobile/performance"
            
          elif [ "$TEST_TYPE" = "Security Tests" ]; then
            TEST_PATH="./tests/security"
            
          else  # All Tests
            TEST_PATH="./tests"
          fi
          
          echo "TEST_PATH=$TEST_PATH" >> $GITHUB_OUTPUT
          echo "Configured path: $TEST_PATH"

  execute_tests:
    needs: validate_and_trigger
    uses: ./.github/workflows/test_runner.yml
    with:
      test_type: ${{ github.event.inputs.test_type }}
      test_suite: ${{ github.event.inputs.test_suite }}
      browser: ${{ github.event.inputs.browser }}
      environment: ${{ github.event.inputs.environment }}
      custom_tags: ${{ github.event.inputs.custom_tags }}
      priority: ${{ github.event.inputs.priority }}
      test_path: ${{ needs.validate_and_trigger.outputs.test_path }}
      run_id: ${{ needs.validate_and_trigger.outputs.run_id }}
    secrets: inherit

  generate_reports:
    needs: execute_tests
    if: always()
    uses: ./.github/workflows/report_generator.yml
    with:
      test_type: ${{ github.event.inputs.test_type }}
      test_suite: ${{ github.event.inputs.test_suite }}
      browser: ${{ github.event.inputs.browser }}
      environment: ${{ github.event.inputs.environment }}
      priority: ${{ github.event.inputs.priority }}
      run_id: ${{ needs.validate_and_trigger.outputs.run_id }}
    secrets: inherit
