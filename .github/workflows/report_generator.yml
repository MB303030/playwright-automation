name: Report Generator

on:
  workflow_call:
    inputs:
      test_type:
        required: true
        type: string
      test_suite:
        required: true
        type: string
      browser:
        required: true
        type: string
      environment:
        required: true
        type: string
      priority:
        required: true
        type: string
      run_id:
        required: true
        type: string

jobs:
  generate_reports:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
      
      - name: üì• Download Test Results
        uses: actions/download-artifact@v4
        with:
          name: test-results-${{ inputs.run_id }}
          path: ./downloaded-results/
        continue-on-error: true  # Continue even if download fails
      
      - name: üìä Read or Create Test Results
        id: read_results
        run: |
          echo "üìä Processing test results..."
          
          STATS_FILE="./downloaded-results/test-results/${{ inputs.run_id }}/statistics.json"
          RESULTS_FILE="./downloaded-results/test-results/${{ inputs.run_id }}/results.json"
          
          if [ -f "$STATS_FILE" ]; then
            echo "‚úÖ Found statistics file"
            
            # Read values from JSON file using grep
            TOTAL_TESTS=$(grep -o '"total_tests"[[:space:]]*:[[:space:]]*[0-9]*' "$STATS_FILE" | head -1 | grep -o '[0-9]*' || echo "0")
            PASSED_TESTS=$(grep -o '"passed_tests"[[:space:]]*:[[:space:]]*[0-9]*' "$STATS_FILE" | head -1 | grep -o '[0-9]*' || echo "0")
            FAILED_TESTS=$(grep -o '"failed_tests"[[:space:]]*:[[:space:]]*[0-9]*' "$STATS_FILE" | head -1 | grep -o '[0-9]*' || echo "0")
            SKIPPED_TESTS=$(grep -o '"skipped_tests"[[:space:]]*:[[:space:]]*[0-9]*' "$STATS_FILE" | head -1 | grep -o '[0-9]*' || echo "0")
            DURATION=$(grep -o '"duration"[[:space:]]*:[[:space:]]*[0-9]*' "$STATS_FILE" | head -1 | grep -o '[0-9]*' || echo "0")
            SUCCESS_RATE=$(grep -o '"success_rate"[[:space:]]*:[[:space:]]*[0-9]*' "$STATS_FILE" | head -1 | grep -o '[0-9]*' || echo "0")
            
            echo "üìà Statistics loaded from file"
            
          elif [ -f "$RESULTS_FILE" ]; then
            echo "‚úÖ Found results file"
            
            TOTAL_TESTS=$(grep -o '"total_tests"[[:space:]]*:[[:space:]]*[0-9]*' "$RESULTS_FILE" | head -1 | grep -o '[0-9]*' || echo "0")
            PASSED_TESTS=$(grep -o '"passed"[[:space:]]*:[[:space:]]*[0-9]*' "$RESULTS_FILE" | head -1 | grep -o '[0-9]*' || echo "0")
            FAILED_TESTS=$(grep -o '"failed"[[:space:]]*:[[:space:]]*[0-9]*' "$RESULTS_FILE" | head -1 | grep -o '[0-9]*' || echo "0")
            SKIPPED_TESTS=$(grep -o '"skipped"[[:space:]]*:[[:space:]]*[0-9]*' "$RESULTS_FILE" | head -1 | grep -o '[0-9]*' || echo "0")
            DURATION=$(grep -o '"duration"[[:space:]]*:[[:space:]]*[0-9]*' "$RESULTS_FILE" | head -1 | grep -o '[0-9]*' || echo "0")
            
            if [ "$TOTAL_TESTS" -gt 0 ]; then
              SUCCESS_RATE=$((PASSED_TESTS * 100 / TOTAL_TESTS))
            else
              SUCCESS_RATE=0
            fi
            
            echo "üìà Statistics extracted from results"
            
          else
            echo "‚ö†Ô∏è No results files found, creating default statistics"
            TOTAL_TESTS=0
            PASSED_TESTS=0
            FAILED_TESTS=1
            SKIPPED_TESTS=0
            DURATION=0
            SUCCESS_RATE=0
          fi
          
          # Calculate percentages
          if [ "$TOTAL_TESTS" -gt 0 ]; then
            PASSED_PERCENT=$((PASSED_TESTS * 100 / TOTAL_TESTS))
            FAILED_PERCENT=$((FAILED_TESTS * 100 / TOTAL_TESTS))
            SKIPPED_PERCENT=$((SKIPPED_TESTS * 100 / TOTAL_TESTS))
          else
            PASSED_PERCENT=0
            FAILED_PERCENT=0
            SKIPPED_PERCENT=0
          fi
          
          # Save to environment variables
          echo "TOTAL_TESTS=$TOTAL_TESTS" >> $GITHUB_ENV
          echo "PASSED_TESTS=$PASSED_TESTS" >> $GITHUB_ENV
          echo "FAILED_TESTS=$FAILED_TESTS" >> $GITHUB_ENV
          echo "SKIPPED_TESTS=$SKIPPED_TESTS" >> $GITHUB_ENV
          echo "DURATION=$DURATION" >> $GITHUB_ENV
          echo "SUCCESS_RATE=$SUCCESS_RATE" >> $GITHUB_ENV
          echo "PASSED_PERCENT=$PASSED_PERCENT" >> $GITHUB_ENV
          echo "FAILED_PERCENT=$FAILED_PERCENT" >> $GITHUB_ENV
          echo "SKIPPED_PERCENT=$SKIPPED_PERCENT" >> $GITHUB_ENV
          
          echo "üìã Final Statistics:"
          echo "   Total Tests: $TOTAL_TESTS"
          echo "   Passed: $PASSED_TESTS ($PASSED_PERCENT%)"
          echo "   Failed: $FAILED_TESTS ($FAILED_PERCENT%)"
          echo "   Skipped: $SKIPPED_TESTS ($SKIPPED_PERCENT%)"
          echo "   Success Rate: $SUCCESS_RATE%"
          echo "   Duration: $DURATION seconds"
      
      - name: üìà Create Professional Dashboard
        run: |
          echo "üé® Creating professional dashboard..."
          
          mkdir -p ./reports/${{ inputs.run_id }}
          
          # Create HTML dashboard with simple echo statements
          {
            echo '<!DOCTYPE html>'
            echo '<html lang="en">'
            echo '<head>'
            echo '    <meta charset="UTF-8">'
            echo '    <meta name="viewport" content="width=device-width, initial-scale=1.0">'
            echo '    <title>Test Dashboard - '"${{ inputs.run_id }}"'</title>'
            echo '    <style>'
            echo '        body { font-family: Arial, sans-serif; margin: 40px; }'
            echo '        .card { background: white; border-radius: 10px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }'
            echo '        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }'
            echo '        .stat { text-align: center; padding: 20px; border-radius: 8px; }'
            echo '        .total { background: #e3f2fd; }'
            echo '        .passed { background: #e8f5e9; color: #2e7d32; }'
            echo '        .failed { background: #ffebee; color: #c62828; }'
            echo '        .rate { background: #f3e5f5; color: #6a1b9a; }'
            echo '        .number { font-size: 2.5em; font-weight: bold; display: block; }'
            echo '        .label { font-size: 0.9em; color: #666; }'
            echo '        table { width: 100%; border-collapse: collapse; }'
            echo '        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }'
            echo '        th { background: #f5f5f5; }'
            echo '        .success { color: green; }'
            echo '        .error { color: red; }'
            echo '        .warning { color: orange; }'
            echo '    </style>'
            echo '</head>'
            echo '<body>'
            echo '    <h1>üß™ Test Execution Dashboard</h1>'
            echo '    <p>Run ID: '"${{ inputs.run_id }}"'</p>'
            echo '    '
            echo '    <div class="stats">'
            echo '        <div class="stat total">'
            echo '            <span class="number">'"$TOTAL_TESTS"'</span>'
            echo '            <span class="label">Total Tests</span>'
            echo '        </div>'
            echo '        <div class="stat passed">'
            echo '            <span class="number">'"$PASSED_TESTS"'</span>'
            echo '            <span class="label">Passed Tests</span>'
            echo '        </div>'
            echo '        <div class="stat failed">'
            echo '            <span class="number">'"$FAILED_TESTS"'</span>'
            echo '            <span class="label">Failed Tests</span>'
            echo '        </div>'
            echo '        <div class="stat rate">'
            echo '            <span class="number">'"$SUCCESS_RATE"'%</span>'
            echo '            <span class="label">Success Rate</span>'
            echo '        </div>'
            echo '    </div>'
            echo '    '
            echo '    <div class="card">'
            echo '        <h2>Test Configuration</h2>'
            echo '        <table>'
            echo '            <tr><th>Parameter</th><th>Value</th></tr>'
            echo '            <tr><td>Test Type</td><td>'"${{ inputs.test_type }}"'</td></tr>'
            echo '            <tr><td>Test Suite</td><td>'"${{ inputs.test_suite }}"'</td></tr>'
            echo '            <tr><td>Browser</td><td>'"${{ inputs.browser }}"'</td></tr>'
            echo '            <tr><td>Environment</td><td>'"${{ inputs.environment }}"'</td></tr>'
            echo '            <tr><td>Priority</td><td>'"${{ inputs.priority }}"'</td></tr>'
            echo '            <tr><td>Duration</td><td>'"$DURATION"' seconds</td></tr>'
            echo '        </table>'
            echo '    </div>'
            echo '    '
            echo '    <div class="card">'
            echo '        <h2>Detailed Results</h2>'
            echo '        <table>'
            echo '            <tr><th>Status</th><th>Count</th><th>Percentage</th></tr>'
            echo '            <tr><td class="success">‚úÖ Passed</td><td>'"$PASSED_TESTS"'</td><td>'"$PASSED_PERCENT"'%</td></tr>'
            echo '            <tr><td class="error">‚ùå Failed</td><td>'"$FAILED_TESTS"'</td><td>'"$FAILED_PERCENT"'%</td></tr>'
            echo '            <tr><td class="warning">‚è≠Ô∏è Skipped</td><td>'"$SKIPPED_TESTS"'</td><td>'"$SKIPPED_PERCENT"'%</td></tr>'
            echo '        </table>'
            echo '    </div>'
            echo '    '
            echo '    <div style="margin-top: 30px; color: #666; font-size: 0.9em; text-align: center;">'
            echo '        Generated on '"$(date)"' ‚Ä¢ Professional Test Runner v1.0'
            echo '    </div>'
            echo '</body>'
            echo '</html>'
          } > ./reports/${{ inputs.run_id }}/dashboard.html
          
          echo "‚úÖ Dashboard created!"
      
      - name: üìã Create Summary Report
        run: |
          echo "üìã Creating summary report..."
          
          mkdir -p ./reports/${{ inputs.run_id }}
          
          # Create summary markdown file
          {
            echo "# Test Execution Summary"
            echo ""
            echo "## Run Information"
            echo "- **Run ID:** ${{ inputs.run_id }}"
            echo "- **Timestamp:** $(date)"
            echo "- **Test Type:** ${{ inputs.test_type }}"
            echo "- **Test Suite:** ${{ inputs.test_suite }}"
            echo "- **Browser:** ${{ inputs.browser }}"
            echo "- **Environment:** ${{ inputs.environment }}"
            echo "- **Priority:** ${{ inputs.priority }}"
            echo ""
            echo "## Results Summary"
            echo "- **Total Tests:** $TOTAL_TESTS"
            echo "- **Passed Tests:** $PASSED_TESTS"
            echo "- **Failed Tests:** $FAILED_TESTS"
            echo "- **Skipped Tests:** $SKIPPED_TESTS"
            echo "- **Success Rate:** $SUCCESS_RATE%"
            echo "- **Execution Time:** $DURATION seconds"
            echo ""
            echo "## Status"
          } > ./reports/${{ inputs.run_id }}/summary.md
          
          # Append status based on results
          if [ "$FAILED_TESTS" -eq 0 ] && [ "$TOTAL_TESTS" -gt 0 ]; then
            echo "‚úÖ **ALL TESTS PASSED**" >> ./reports/${{ inputs.run_id }}/summary.md
          elif [ "$TOTAL_TESTS" -eq 0 ]; then
            echo "‚ö†Ô∏è **NO TESTS WERE EXECUTED**" >> ./reports/${{ inputs.run_id }}/summary.md
          else
            echo "‚ùå **$FAILED_TESTS TEST(S) FAILED**" >> ./reports/${{ inputs.run_id }}/summary.md
          fi
          
          echo "" >> ./reports/${{ inputs.run_id }}/summary.md
          echo "---" >> ./reports/${{ inputs.run_id }}/summary.md
          echo "*Generated by Professional Test Runner*" >> ./reports/${{ inputs.run_id }}/summary.md
          
          echo "‚úÖ Summary report created!"
      
      - name: üì§ Upload Final Report Package
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: final-report-${{ inputs.run_id }}
          path: ./reports/${{ inputs.run_id }}
          retention-days: 30
      
      - name: üì¢ Create GitHub Actions Summary
        if: always()
        run: |
          echo "## üéâ Test Execution Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Test Run: ${{ inputs.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Type: ${{ inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- Suite: ${{ inputs.test_suite }}" >> $GITHUB_STEP_SUMMARY
          echo "- Browser: ${{ inputs.browser }}" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- Priority: ${{ inputs.priority }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**üìä Test Results:**" >> $GITHUB_STEP_SUMMARY
          echo "- Total Tests: **$TOTAL_TESTS**" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Passed: **$PASSED_TESTS**" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ùå Failed: **$FAILED_TESTS**" >> $GITHUB_STEP_SUMMARY
          echo "- ‚è≠Ô∏è Skipped: **$SKIPPED_TESTS**" >> $GITHUB_STEP_SUMMARY
          echo "- üìà Success Rate: **$SUCCESS_RATE%**" >> $GITHUB_STEP_SUMMARY
          echo "- ‚è±Ô∏è Duration: **$DURATION seconds**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$FAILED_TESTS" -eq 0 ] && [ "$TOTAL_TESTS" -gt 0 ]; then
            echo "### üéØ **STATUS: ALL TESTS PASSED** üéØ" >> $GITHUB_STEP_SUMMARY
          elif [ "$TOTAL_TESTS" -eq 0 ]; then
            echo "### ‚ö†Ô∏è **STATUS: NO TESTS EXECUTED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ö†Ô∏è **STATUS: $FAILED_TESTS TEST(S) FAILED**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì• Download Reports" >> $GITHUB_STEP_SUMMARY
          echo "Download the **\`final-report-${{ inputs.run_id }}\`** artifact for:" >> $GITHUB_STEP_SUMMARY
          echo "- Interactive Dashboard (dashboard.html)" >> $GITHUB_STEP_SUMMARY
          echo "- Detailed Test Results" >> $GITHUB_STEP_SUMMARY
