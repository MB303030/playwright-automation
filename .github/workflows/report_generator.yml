name: Report Generator

on:
  workflow_call:
    inputs:
      test_type:
        required: true
        type: string
      test_suite:
        required: true
        type: string
      browser:
        required: true
        type: string
      environment:
        required: true
        type: string
      priority:
        required: true
        type: string
      run_id:
        required: true
        type: string

jobs:
  generate_reports:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ“¥ Download Test Results
        uses: actions/download-artifact@v4
        with:
          name: test-results-${{ inputs.run_id }}
          path: ./downloaded-results/
      
      - name: ðŸ“Š Read Test Results
        id: read_results
        run: |
          echo "ðŸ“Š Reading test results..."
          
          STATS_FILE="./downloaded-results/test-results/${{ inputs.run_id }}/statistics.json"
          RESULTS_FILE="./downloaded-results/test-results/${{ inputs.run_id }}/results.json"
          
          if [ -f "$STATS_FILE" ]; then
            echo "âœ… Found statistics file"
            
            # Read values from JSON file using grep (no jq dependency)
            TOTAL_TESTS=$(grep -o '"total_tests"[[:space:]]*:[[:space:]]*[0-9]*' "$STATS_FILE" | head -1 | grep -o '[0-9]*' || echo "0")
            PASSED_TESTS=$(grep -o '"passed_tests"[[:space:]]*:[[:space:]]*[0-9]*' "$STATS_FILE" | head -1 | grep -o '[0-9]*' || echo "0")
            FAILED_TESTS=$(grep -o '"failed_tests"[[:space:]]*:[[:space:]]*[0-9]*' "$STATS_FILE" | head -1 | grep -o '[0-9]*' || echo "0")
            SKIPPED_TESTS=$(grep -o '"skipped_tests"[[:space:]]*:[[:space:]]*[0-9]*' "$STATS_FILE" | head -1 | grep -o '[0-9]*' || echo "0")
            SUCCESS_RATE=$(grep -o '"success_rate"[[:space:]]*:[[:space:]]*[0-9]*' "$STATS_FILE" | head -1 | grep -o '[0-9]*' || echo "0")
            
            echo "ðŸ“ˆ Statistics loaded successfully!"
            
          elif [ -f "$RESULTS_FILE" ]; then
            echo "âœ… Found results file, extracting statistics..."
            
            TOTAL_TESTS=$(grep -o '"total_tests"[[:space:]]*:[[:space:]]*[0-9]*' "$RESULTS_FILE" | head -1 | grep -o '[0-9]*' || echo "0")
            PASSED_TESTS=$(grep -o '"passed"[[:space:]]*:[[:space:]]*[0-9]*' "$RESULTS_FILE" | head -1 | grep -o '[0-9]*' || echo "0")
            FAILED_TESTS=$(grep -o '"failed"[[:space:]]*:[[:space:]]*[0-9]*' "$RESULTS_FILE" | head -1 | grep -o '[0-9]*' || echo "0")
            SKIPPED_TESTS=$(grep -o '"skipped"[[:space:]]*:[[:space:]]*[0-9]*' "$RESULTS_FILE" | head -1 | grep -o '[0-9]*' || echo "0")
            
            if [ "$TOTAL_TESTS" -gt 0 ]; then
              SUCCESS_RATE=$((PASSED_TESTS * 100 / TOTAL_TESTS))
            else
              SUCCESS_RATE=0
            fi
            
          else
            echo "âš ï¸ No results files found, using defaults"
            TOTAL_TESTS=0
            PASSED_TESTS=0
            FAILED_TESTS=0
            SKIPPED_TESTS=0
            SUCCESS_RATE=0
          fi
          
          # Calculate percentages
          if [ "$TOTAL_TESTS" -gt 0 ]; then
            PASSED_PERCENT=$((PASSED_TESTS * 100 / TOTAL_TESTS))
            FAILED_PERCENT=$((FAILED_TESTS * 100 / TOTAL_TESTS))
            SKIPPED_PERCENT=$((SKIPPED_TESTS * 100 / TOTAL_TESTS))
          else
            PASSED_PERCENT=0
            FAILED_PERCENT=0
            SKIPPED_PERCENT=0
          fi
          
          echo "ðŸ“‹ Final Statistics:"
          echo "   Total Tests: $TOTAL_TESTS"
          echo "   Passed: $PASSED_TESTS ($PASSED_PERCENT%)"
          echo "   Failed: $FAILED_TESTS ($FAILED_PERCENT%)"
          echo "   Skipped: $SKIPPED_TESTS ($SKIPPED_PERCENT%)"
          echo "   Success Rate: $SUCCESS_RATE%"
          
          # Save to environment variables
          echo "TOTAL_TESTS=$TOTAL_TESTS" >> $GITHUB_ENV
          echo "PASSED_TESTS=$PASSED_TESTS" >> $GITHUB_ENV
          echo "FAILED_TESTS=$FAILED_TESTS" >> $GITHUB_ENV
          echo "SKIPPED_TESTS=$SKIPPED_TESTS" >> $GITHUB_ENV
          echo "SUCCESS_RATE=$SUCCESS_RATE" >> $GITHUB_ENV
          echo "PASSED_PERCENT=$PASSED_PERCENT" >> $GITHUB_ENV
          echo "FAILED_PERCENT=$FAILED_PERCENT" >> $GITHUB_ENV
          echo "SKIPPED_PERCENT=$SKIPPED_PERCENT" >> $GITHUB_ENV
      
      - name: ðŸ“ˆ Create Professional Dashboard
        run: |
          echo "ðŸŽ¨ Creating professional dashboard..."
          
          mkdir -p ./reports/${{ inputs.run_id }}
          
          # Create HTML dashboard WITHOUT EOF issues
          {
            echo '<!DOCTYPE html>'
            echo '<html lang="en">'
            echo '<head>'
            echo '    <meta charset="UTF-8">'
            echo '    <meta name="viewport" content="width=device-width, initial-scale=1.0">'
            echo '    <title>Test Dashboard - ${{ inputs.run_id }}</title>'
            echo '    <script src="https://cdn.tailwindcss.com"></script>'
            echo '    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">'
            echo '    <style>'
            echo '        body { font-family: "Segoe UI", sans-serif; }'
            echo '        .stat-card { transition: transform 0.3s; }'
            echo '        .stat-card:hover { transform: translateY(-5px); }'
            echo '    </style>'
            echo '</head>'
            echo '<body class="bg-gray-50">'
            echo '    <div class="container mx-auto px-4 py-8">'
            echo '        <h1 class="text-3xl font-bold text-gray-800 mb-2">ðŸ§ª Test Execution Dashboard</h1>'
            echo '        <p class="text-gray-600 mb-8">Run ID: ${{ inputs.run_id }}</p>'
            echo '        '
            echo '        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">'
            echo '            <div class="stat-card bg-white rounded-xl shadow p-6">'
            echo '                <div class="text-3xl font-bold text-blue-600">'$TOTAL_TESTS'</div>'
            echo '                <div class="text-gray-600">Total Tests</div>'
            echo '            </div>'
            echo '            <div class="stat-card bg-white rounded-xl shadow p-6">'
            echo '                <div class="text-3xl font-bold text-green-600">'$PASSED_TESTS'</div>'
            echo '                <div class="text-gray-600">Passed Tests</div>'
            echo '            </div>'
            echo '            <div class="stat-card bg-white rounded-xl shadow p-6">'
            echo '                <div class="text-3xl font-bold text-red-600">'$FAILED_TESTS'</div>'
            echo '                <div class="text-gray-600">Failed Tests</div>'
            echo '            </div>'
            echo '            <div class="stat-card bg-white rounded-xl shadow p-6">'
            echo '                <div class="text-3xl font-bold text-purple-600">'$SUCCESS_RATE'%</div>'
            echo '                <div class="text-gray-600">Success Rate</div>'
            echo '            </div>'
            echo '        </div>'
            echo '        '
            echo '        <div class="bg-white rounded-xl shadow p-6 mb-8">'
            echo '            <h2 class="text-xl font-bold text-gray-800 mb-4">Test Configuration</h2>'
            echo '            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">'
            echo '                <div>'
            echo '                    <div class="text-gray-500 text-sm">Test Type</div>'
            echo '                    <div class="font-medium">${{ inputs.test_type }}</div>'
            echo '                </div>'
            echo '                <div>'
            echo '                    <div class="text-gray-500 text-sm">Browser</div>'
            echo '                    <div class="font-medium">${{ inputs.browser }}</div>'
            echo '                </div>'
            echo '                <div>'
            echo '                    <div class="text-gray-500 text-sm">Environment</div>'
            echo '                    <div class="font-medium">${{ inputs.environment }}</div>'
            echo '                </div>'
            echo '                <div>'
            echo '                    <div class="text-gray-500 text-sm">Priority</div>'
            echo '                    <div class="font-medium">${{ inputs.priority }}</div>'
            echo '                </div>'
            echo '            </div>'
            echo '        </div>'
            echo '        '
            echo '        <div class="bg-white rounded-xl shadow p-6">'
            echo '            <h2 class="text-xl font-bold text-gray-800 mb-4">Detailed Results</h2>'
            echo '            <table class="min-w-full">'
            echo '                <thead>'
            echo '                    <tr class="border-b">'
            echo '                        <th class="py-2 text-left">Metric</th>'
            echo '                        <th class="py-2 text-left">Count</th>'
            echo '                        <th class="py-2 text-left">Percentage</th>'
            echo '                    </tr>'
            echo '                </thead>'
            echo '                <tbody>'
            echo '                    <tr class="border-b">'
            echo '                        <td class="py-3 text-green-600"><i class="fas fa-check mr-2"></i>Passed</td>'
            echo '                        <td class="py-3 font-bold">'$PASSED_TESTS'</td>'
            echo '                        <td class="py-3">'$PASSED_PERCENT'%</td>'
            echo '                    </tr>'
            echo '                    <tr class="border-b">'
            echo '                        <td class="py-3 text-red-600"><i class="fas fa-times mr-2"></i>Failed</td>'
            echo '                        <td class="py-3 font-bold">'$FAILED_TESTS'</td>'
            echo '                        <td class="py-3">'$FAILED_PERCENT'%</td>'
            echo '                    </tr>'
            echo '                    <tr>'
            echo '                        <td class="py-3 text-yellow-600"><i class="fas fa-forward mr-2"></i>Skipped</td>'
            echo '                        <td class="py-3 font-bold">'$SKIPPED_TESTS'</td>'
            echo '                        <td class="py-3">'$SKIPPED_PERCENT'%</td>'
            echo '                    </tr>'
            echo '                </tbody>'
            echo '            </table>'
            echo '        </div>'
            echo '        '
            echo '        <div class="mt-8 text-center text-gray-500 text-sm">'
            echo '            Generated on $(date) â€¢ Professional Test Runner v1.0'
            echo '        </div>'
            echo '    </div>'
            echo '</body>'
            echo '</html>'
          } > ./reports/${{ inputs.run_id }}/dashboard.html
          
          echo "âœ… Dashboard created!"
      
      - name: ðŸ“‹ Create Summary Report
        run: |
          echo "ðŸ“‹ Creating summary report..."
          
          {
            echo "# Test Execution Summary"
            echo ""
            echo "## Run Information"
            echo "- **Run ID:** ${{ inputs.run_id }}"
            echo "- **Timestamp:** $(date)"
            echo "- **Test Type:** ${{ inputs.test_type }}"
            echo "- **Test Suite:** ${{ inputs.test_suite }}"
            echo "- **Browser:** ${{ inputs.browser }}"
            echo "- **Environment:** ${{ inputs.environment }}"
            echo "- **Priority:** ${{ inputs.priority }}"
            echo ""
            echo "## Results Summary"
            echo "- **Total Tests:** $TOTAL_TESTS"
            echo "- **Passed Tests:** $PASSED_TESTS"
            echo "- **Failed Tests:** $FAILED_TESTS"
            echo "- **Skipped Tests:** $SKIPPED_TESTS"
            echo "- **Success Rate:** $SUCCESS_RATE%"
            echo ""
            echo "## Status"
            if [ $FAILED_TESTS -eq 0 ]; then
              echo "âœ… **ALL TESTS PASSED**"
            else
              echo "âŒ **$FAILED_TESTS TEST(S) FAILED**"
            fi
            echo ""
            echo "---"
            echo "*Generated by Professional Test Runner*"
          } > ./reports/${{ inputs.run_id }}/summary.md
          
          echo "âœ… Summary report created!"
      
      - name: ðŸ“¦ Package Final Report
        run: |
          echo "ðŸ“¦ Packaging final report..."
          
          # Copy any additional files from test results
          if [ -d "./downloaded-results/test-results/${{ inputs.run_id }}" ]; then
            cp -r ./downloaded-results/test-results/${{ inputs.run_id }}/* ./reports/${{ inputs.run_id }}/ 2>/dev/null || true
          fi
          
          # Create a manifest file
          {
            echo "Report Package for Run: ${{ inputs.run_id }}"
            echo "========================================"
            echo ""
            echo "Files included:"
            echo "1. dashboard.html - Interactive dashboard"
            echo "2. summary.md - Executive summary"
            echo "3. statistics.json - Raw statistics"
            echo "4. results.json - Detailed test results"
            echo ""
            echo "Generated: $(date)"
          } > ./reports/${{ inputs.run_id }}/MANIFEST.txt
      
      - name: ðŸ“¤ Upload Final Report Package
        uses: actions/upload-artifact@v4
        with:
          name: final-report-${{ inputs.run_id }}
          path: ./reports/${{ inputs.run_id }}
          retention-days: 30
      
      - name: ðŸ“¢ Create GitHub Actions Summary
        run: |
          echo "## ðŸŽ‰ Test Execution Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Test Run: ${{ inputs.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Type: ${{ inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- Suite: ${{ inputs.test_suite }}" >> $GITHUB_STEP_SUMMARY
          echo "- Browser: ${{ inputs.browser }}" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- Priority: ${{ inputs.priority }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**ðŸ“Š Test Results:**" >> $GITHUB_STEP_SUMMARY
          echo "- Total Tests: **$TOTAL_TESTS**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Passed: **$PASSED_TESTS**" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ Failed: **$FAILED_TESTS**" >> $GITHUB_STEP_SUMMARY
          echo "- â­ï¸ Skipped: **$SKIPPED_TESTS**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ˆ Success Rate: **$SUCCESS_RATE%**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $FAILED_TESTS -eq 0 ]; then
            echo "### ðŸŽ¯ **STATUS: ALL TESTS PASSED** ðŸŽ¯" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ **STATUS: $FAILED_TESTS TEST(S) FAILED**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download Reports" >> $GITHUB_STEP_SUMMARY
          echo "Download the **\`final-report-${{ inputs.run_id }}\`** artifact for:" >> $GITHUB_STEP_SUMMARY
          echo "- Interactive Dashboard (dashboard.html)" >> $GITHUB_STEP_SUMMARY
          echo "- Detailed Test Results" >> $GITHUB_STEP_SUMMARY
