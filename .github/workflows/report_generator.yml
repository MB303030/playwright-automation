name: Report Generator

on:
  workflow_call:
    inputs:
      test_type:
        required: true
        type: string
      test_suite:
        required: true
        type: string
      browser:
        required: true
        type: string
      environment:
        required: true
        type: string
      priority:
        required: true
        type: string
      run_id:
        required: true
        type: string

jobs:
  generate_reports:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Download Playwright Report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report-${{ inputs.run_id }}
          path: ./downloaded-report
        continue-on-error: true
      
      - name: ðŸ“¥ Download Test Results
        uses: actions/download-artifact@v4
        with:
          name: test-results-${{ inputs.run_id }}
          path: ./downloaded-results
        continue-on-error: true
      
      - name: ðŸ“Š Create Simple GitHub Summary
        run: |
          echo "## ðŸ§ª Playwright Test Execution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ inputs.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Test Type:** ${{ inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Test Suite:** ${{ inputs.test_suite }}" >> $GITHUB_STEP_SUMMARY
          echo "**Browser:** ${{ inputs.browser }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if report exists
          if [ -d "./downloaded-report" ]; then
            echo "âœ… **Playwright HTML Report is available**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Download the **playwright-report-${{ inputs.run_id }}** artifact to view the full interactive report." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **No Playwright report found**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The test execution might have failed before generating a report." >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for JSON results
          if [ -f "./downloaded-results/test-results.json" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š **Test results available in JSON format**" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ”— Generate Report Link
        run: |
          echo "ðŸ“‹ Test Execution Summary:" | tee -a summary.txt
          echo "Run ID: ${{ inputs.run_id }}" | tee -a summary.txt
          echo "Test Type: ${{ inputs.test_type }}" | tee -a summary.txt
          echo "Test Suite: ${{ inputs.test_suite }}" | tee -a summary.txt
          echo "Browser: ${{ inputs.browser }}" | tee -a summary.txt
          echo "Status: Completed" | tee -a summary.txt
          echo "" | tee -a summary.txt
          echo "To view the full Playwright HTML report:" | tee -a summary.txt
          echo "1. Go to the 'Summary' tab" | tee -a summary.txt
          echo "2. Download the 'playwright-report-${{ inputs.run_id }}' artifact" | tee -a summary.txt
          echo "3. Extract and open index.html in a browser" | tee -a summary.txt
          
          mkdir -p ./reports/${{ inputs.run_id }}
          cp summary.txt ./reports/${{ inputs.run_id }}/
      
      - name: ðŸ“¤ Upload Simple Summary
        uses: actions/upload-artifact@v4
        with:
          name: report-summary-${{ inputs.run_id }}
          path: ./reports/${{ inputs.run_id }}
          retention-days: 30
