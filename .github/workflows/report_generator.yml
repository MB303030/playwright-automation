name: Report Generator

on:
  workflow_call:
    inputs:
      test_suite:
        required: true
        type: string
      browser:
        required: true
        type: string
      run_id:
        required: true
        type: string

jobs:
  generate_final_report:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Download HTML Report
        uses: actions/download-artifact@v4
        with:
          name: playwright-html-report-${{ inputs.run_id }}
          path: ./downloaded-html-report
        continue-on-error: true
      
      - name: ðŸ“¥ Download Test Results
        uses: actions/download-artifact@v4
        with:
          name: test-results-${{ inputs.run_id }}
          path: ./downloaded-test-results
        continue-on-error: true
      
      - name: ðŸ“Š Create Final Report Summary
        run: |
          echo "## ðŸŽ‰ Test Execution Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Test Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Suite:** ${{ inputs.test_suite }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Browser:** ${{ inputs.browser }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID:** ${{ inputs.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if HTML report was generated
          if [ -f "./downloaded-html-report/index.html" ]; then
            echo "### âœ… Playwright HTML Report Generated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Download and view the interactive HTML report:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to the **Summary** tab of this workflow run" >> $GITHUB_STEP_SUMMARY
            echo "2. Download the **playwright-html-report-${{ inputs.run_id }}** artifact" >> $GITHUB_STEP_SUMMARY
            echo "3. Extract the ZIP file" >> $GITHUB_STEP_SUMMARY
            echo "4. Open **index.html** in a web browser" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š The report includes:" >> $GITHUB_STEP_SUMMARY
            echo "- Test results overview" >> $GITHUB_STEP_SUMMARY
            echo "- Pass/fail statistics" >> $GITHUB_STEP_SUMMARY
            echo "- Screenshots of failures" >> $GITHUB_STEP_SUMMARY
            echo "- Execution timeline" >> $GITHUB_STEP_SUMMARY
            echo "- Trace viewer for debugging" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ HTML Report Not Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The HTML report could not be generated or downloaded." >> $GITHUB_STEP_SUMMARY
            echo "Check the test execution logs for errors." >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for test results
          if [ -d "./downloaded-test-results" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ Additional Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "Raw test results are available in the **test-results-${{ inputs.run_id }}** artifact." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ“‹ Create Report Readme
        run: |
          mkdir -p ./final-report/${{ inputs.run_id }}
          
          cat > ./final-report/${{ inputs.run_id }}/README.md << EOF
          # Playwright Test Report
          
          ## Test Run Information
          - **Run ID:** ${{ inputs.run_id }}
          - **Test Suite:** ${{ inputs.test_suite }}
          - **Browser:** ${{ inputs.browser }}
          - **Generated:** $(date)
          
          ## How to View the Report
          1. Download the \`playwright-html-report-${{ inputs.run_id }}\` artifact
          2. Extract the ZIP file
          3. Open \`index.html\` in a web browser
          
          ## Report Contents
          - Test execution results
          - Pass/fail statistics
          - Screenshots for failed tests
          - Execution timeline
          - Trace viewer for debugging
          
          ## Raw Results
          Raw test results are available in the \`test-results-${{ inputs.run_id }}\` artifact.
          EOF
      
      - name: ðŸ“¤ Upload Final Report Package
        uses: actions/upload-artifact@v4
        with:
          name: final-report-package-${{ inputs.run_id }}
          path: ./final-report/${{ inputs.run_id }}
          retention-days: 30
