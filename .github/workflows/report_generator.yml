name: Test Runner

on:
  workflow_call:
    inputs:
      test_type:
        required: true
        type: string
      test_suite:
        required: true
        type: string
      browser:
        required: true
        type: string
      environment:
        required: true
        type: string
      custom_tags:
        required: false
        type: string
        default: ''
      priority:
        required: true
        type: string
      test_path:
        required: true
        type: string
      run_id:
        required: true
        type: string

env:
  CI: true

jobs:
  run_tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
      
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          if [ -f "package.json" ]; then
            npm ci
          else
            echo "‚ùå Error: No package.json found!"
            exit 1
          fi
      
      - name: üîß Install Playwright Browsers
        run: |
          echo "üîß Installing Playwright browsers..."
          npx playwright install --with-deps
      
      - name: üß™ Run Playwright Tests
        id: run_playwright
        continue-on-error: true
        run: |
          echo "üöÄ Running Playwright tests..."
          echo "üìÇ Test path: ${{ inputs.test_path }}"
          echo "üåê Browser: ${{ inputs.browser }}"
          
          # Check if test path exists
          if [ ! -d "${{ inputs.test_path }}" ] && [ ! -f "${{ inputs.test_path }}" ]; then
            echo "‚ùå Error: Test path '${{ inputs.test_path }}' does not exist."
            echo "üìã Available test directories:"
            find ./tests -type d -name "*.spec.js" -o -name "*.test.js" 2>/dev/null || true
            exit 1
          fi
          
          # Map browser name to Playwright project name
          if [ "${{ inputs.browser }}" = "chrome" ]; then
            PROJECT="chromium"
          elif [ "${{ inputs.browser }}" = "firefox" ]; then
            PROJECT="firefox"
          elif [ "${{ inputs.browser }}" = "webkit" ]; then
            PROJECT="webkit"
          else
            PROJECT="${{ inputs.browser }}"
          fi
          
          # Create unique directories for this run
          HTML_REPORT_DIR="./playwright-html-report/${{ inputs.run_id }}"
          TEST_RESULTS_DIR="./test-results/${{ inputs.run_id }}"
          
          mkdir -p $HTML_REPORT_DIR
          mkdir -p $TEST_RESULTS_DIR
          
          echo "üìÅ HTML Report: $HTML_REPORT_DIR"
          echo "üìÅ Test Results: $TEST_RESULTS_DIR"
          
          # Run Playwright tests
          npx playwright test \
            "${{ inputs.test_path }}" \
            --project="$PROJECT" \
            --reporter=html,line \
            --output="$TEST_RESULTS_DIR" \
            --retries=1
      
      - name: üì¶ Upload Playwright HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-html-report-${{ inputs.run_id }}
          path: ./playwright-html-report/${{ inputs.run_id }}
          retention-days: 7
      
      - name: üì¶ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ inputs.run_id }}
          path: ./test-results/${{ inputs.run_id }}
          retention-days: 7
