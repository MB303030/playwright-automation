name: Test Allure MINIMAL

on:
  workflow_dispatch:  # Manual trigger ONLY

jobs:
  test-allure:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install Node.js & dependencies
        run: |
          npm install -g allure-commandline
          npm ci
          npx playwright install chromium
          allure --version

      - name: ðŸ§ª Run tests to generate Allure results
        run: |
          # Create a simple test
          cat > test.js << 'EOF'
          const { test, expect } = require('@playwright/test');
          test('test 1', async ({ page }) => {
            await page.goto('https://example.com');
            await expect(page).toHaveTitle('Example Domain');
          });
          test('test 2', async ({ page }) => {
            await page.goto('https://google.com');
            await expect(page).toHaveTitle('Google');
          });
          EOF
          
          # Run with Allure reporter using your config
          npx playwright test test.js --config=playwright.ci.config.js
          
          # Check what was generated
          echo "=== Generated files ==="
          ls -la
          if [ -d "allure-results" ]; then
            echo "Allure results directory:"
            ls -la allure-results/
          fi

      - name: ðŸ“Š Generate Allure HTML report using Marketplace Action
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: allure-results
          allure_report: allure-report
          gh_pages: false

      - name: ðŸ“¤ Upload Allure HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-html-report
          path: allure-report/

      - name: ðŸ“¤ Upload Allure raw results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-raw-results
          path: allure-results/

      - name: ðŸ“‹ Show result
        if: always()
        run: |
          echo "## ðŸŽ­ Allure Test Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "allure-results" ]; then
            echo "âœ… **Allure raw results generated**" >> $GITHUB_STEP_SUMMARY
            echo "Files: $(find allure-results -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **No Allure raw results**" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "allure-report" ] && [ -f "allure-report/index.html" ]; then
            echo "âœ… **Allure HTML report generated**" >> $GITHUB_STEP_SUMMARY
            echo "Download: 'allure-html-report' artifact" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **No Allure HTML report**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Debug Info:" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "Directory listing:" >> $GITHUB_STEP_SUMMARY
          ls -la >> $GITHUB_STEP_SUMMARY 2>&1
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "allure-results" ]; then
            echo "Allure results files:" >> $GITHUB_STEP_SUMMARY
            find allure-results -type f >> $GITHUB_STEP_SUMMARY 2>&1
          fi
          echo "```" >> $GITHUB_STEP_SUMMARY
