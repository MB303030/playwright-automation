name: Playwright Tests with Allure & GitHub Pages

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1Ô∏è‚É£ Verify Docker
      - name: ‚úÖ Verify Docker
        run: |
          docker --version
          docker run --rm alpine:latest echo "‚úì Docker verified"
      
      # 2Ô∏è‚É£ Checkout
      - uses: actions/checkout@v4
      
      # 3Ô∏è‚É£ Setup Node
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # 4Ô∏è‚É£ Install dependencies
      - run: npm ci
      - run: npm install allure-playwright --save-dev
      
      # 5Ô∏è‚É£ Install browsers
      - run: npx playwright install chromium
      
      # 6Ô∏è‚É£ Install Allure (Simpler method)
      - name: Install Allure CLI
        uses: joshuaavalon/setup-allure@v1
      
      # 7Ô∏è‚É£ Create allure-results directory FIRST
      - name: Setup Allure directories
        run: |
          mkdir -p allure-results
          mkdir -p allure-report
          echo "Directories created"
      
      # 8Ô∏è‚É£ Run tests and ensure results are created
      - name: Run tests with Allure
        id: run-tests
        continue-on-error: true
        run: |
          echo "Running tests with Allure reporter..."
          npx playwright test --reporter=line,allure-playwright
          
          # Check if results were created
          if [ -d "allure-results" ] && [ "$(ls -A allure-results 2>/dev/null)" ]; then
            echo "‚úÖ Allure results generated"
            echo "has_results=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è No Allure results found"
            echo "has_results=false" >> $GITHUB_OUTPUT
            
            # Create dummy results for testing
            mkdir -p allure-results
            cat > allure-results/dummy-result.json << EOF
            {
              "name": "Test execution",
              "status": "failed",
              "stage": "finished",
              "steps": [],
              "attachments": []
            }
            EOF
          fi
      
      # 9Ô∏è‚É£ Generate report (ALWAYS)
      - name: Generate Allure report
        if: always()
        run: |
          echo "Generating Allure report..."
          
          # Check what we have
          echo "=== Checking allure-results ==="
          ls -la allure-results/ 2>/dev/null || echo "No allure-results dir"
          
          echo "=== Generating report ==="
          allure generate allure-results -o allure-report --clean
          
          # Create a fallback report if empty
          if [ ! -f "allure-report/index.html" ]; then
            echo "Creating fallback report..."
            mkdir -p allure-report
            cat > allure-report/index.html << 'EOF'
            <!DOCTYPE html>
            <html>
            <head>
                <title>Test Report - No Results</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 40px; }
                    .container { max-width: 800px; margin: 0 auto; }
                    .error { color: #d9534f; background: #f2dede; padding: 15px; border-radius: 5px; }
                    .info { color: #31708f; background: #d9edf7; padding: 15px; border-radius: 5px; }
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>‚ö†Ô∏è No Test Results Generated</h1>
                    <div class="error">
                        <p>Tests may have failed before generating Allure results.</p>
                        <p>Check workflow logs for errors.</p>
                    </div>
                    <div class="info">
                        <p><strong>Expected URL:</strong> https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/</p>
                        <p><strong>Workflow Run:</strong> <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Logs</a></p>
                    </div>
                </div>
            </body>
            </html>
            EOF
          fi
          
          echo "‚úÖ Report ready: allure-report/"
          ls -la allure-report/
      
      # üîü Upload artifact
      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/
      
      # 1Ô∏è‚É£1Ô∏è‚É£ Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        id: deploy-pages
        if: always() && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          destination_dir: ./reports
          force_orphan: true
      
      # 1Ô∏è‚É£2Ô∏è‚É£ PRINT THE DIRECT LINK
      - name: üéØ SHOW REPORT LINK
        if: always()
        run: |
          echo "=========================================="
          echo "            üìä ALLURE REPORT              "
          echo "=========================================="
          echo ""
          echo "üåê ONLINE VERSION:"
          echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/"
          echo ""
          echo "üì• DOWNLOAD VERSION:"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts"
          echo ""
          echo "üîß TROUBLESHOOTING:"
          echo "1. Wait 1-2 minutes for GitHub Pages to deploy"
          echo "2. Check: https://github.com/MB303030/playwright-automation/deployments"
          echo "3. Enable Pages in repo Settings ‚Üí Pages"
          echo "=========================================="
      
      # 1Ô∏è‚É£3Ô∏è‚É£ Add link to workflow summary
      - name: Add to workflow summary
        if: always()
        run: |
          REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/"
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts"
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## üéØ Test Report Generated
          
          ### üìä View Online:
          [üåê $REPORT_URL]($REPORT_URL)
          
          ### üì• Download:
          [üì¶ Download Report]($DOWNLOAD_URL)
          
          ### ‚öôÔ∏è Configuration:
          1. **GitHub Pages**: Must be enabled in repo Settings ‚Üí Pages
          2. **Branch**: \`gh-pages\`
          3. **Folder**: \`/ (root)\`
          
          ### üîç Debug:
          - Check deployment status: [Deployments](https://github.com/${{ github.repository }}/deployments)
          - Enable Pages: [Settings ‚Üí Pages](https://github.com/${{ github.repository }}/settings/pages)
          
          *Note: It may take 1-2 minutes for the link to work after first deployment*
          EOF
