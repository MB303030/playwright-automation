# .gitlab-ci.yml
stages:
  - test
  - report

variables:
  # Cache directories for Node modules and Playwright browsers
  NODE_MODULES_CACHE: "node_modules"
  PLAYWRIGHT_BROWSERS_CACHE: "~/.cache/ms-playwright"

# Cache configuration
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - ~/.cache/ms-playwright/
  policy: pull-push

# Install dependencies and Playwright browsers
install-deps:
  stage: .pre
  image: node:18-alpine
  script:
    - npm ci
    - npx playwright install --with-deps chromium
  artifacts:
    expire_in: 1 hour
    paths:
      - node_modules/
      - ~/.cache/ms-playwright/

# Run Playwright tests
playwright-tests:
  stage: test
  image: node:18-alpine
  needs: ["install-deps"]
  script:
    - echo "Running Playwright tests with Allure reporting..."
    # Run tests and generate Allure results
    - npm test || true  # Continue even if tests fail
    
    # Check if Allure results exist
    - echo "Checking for Allure results..."
    - ls -la allure-results/ || echo "No allure-results directory found"
  artifacts:
    when: always  # Always upload artifacts even if tests fail
    paths:
      - allure-results/
      - test-results/
      - playwright-report/
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'

# Generate and serve Allure report
allure-report:
  stage: report
  image: node:18-alpine
  needs: ["playwright-tests"]
  before_script:
    - npm install -g allure-commandline
  script:
    - echo "Generating Allure report..."
    
    # Generate HTML report from results
    - allure generate allure-results --clean -o allure-report
    
    # Create a simple index.html to view the report
    - echo "<!DOCTYPE html>
      <html>
      <head>
        <title>Test Report</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 40px; }
          a { color: #1f78d1; text-decoration: none; }
          a:hover { text-decoration: underline; }
        </style>
      </head>
      <body>
        <h1>üìä Test Execution Report</h1>
        <p><strong>Branch:</strong> ${CI_COMMIT_REF_NAME}</p>
        <p><strong>Pipeline:</strong> <a href='${CI_PIPELINE_URL}'>${CI_PIPELINE_ID}</a></p>
        <h2>üìÅ Available Reports:</h2>
        <ul>
          <li><a href='allure-report/index.html'>üìà Allure Report</a> (Interactive)</li>
          <li><a href='playwright-report/index.html'>üé≠ Playwright Report</a></li>
        </ul>
        <h2>üîç Artifacts for Debugging:</h2>
        <p>Download artifacts from the pipeline to see:</p>
        <ul>
          <li>Screenshots of failed tests</li>
          <li>Video recordings</li>
          <li>Trace files</li>
        </ul>
      </body>
      </html>" > public/index.html
  artifacts:
    paths:
      - allure-report/
      - public/
    expire_in: 30 days
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
