# .github/workflows/playwright-ci.yml
name: Playwright CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual trigger

jobs:
  # Check Docker is available
  check-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Verify Docker installation
        run: |
          which docker || echo "âŒ Docker not found"
          docker --version
          echo "âœ… Docker check complete"

  # Run Playwright tests with CI config
  playwright-tests:
    runs-on: ubuntu-latest
    needs: check-docker  # Optional - remove if not needed
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸŽ­ Install Playwright browsers
      run: npx playwright install --with-deps chromium

    - name: ðŸ”§ List files for debugging
      run: |
        echo "Current directory:"
        pwd
        echo "Files in root:"
        ls -la
        echo "Config files:"
        ls -la playwright*.config.js || echo "No config files found"

    - name: ðŸ§ª Run Playwright tests (CI config)
      run: |
        echo "Running tests with CI config..."
        # Run with your CI-specific config
        npx playwright test --config=playwright.ci.config.js
      continue-on-error: true  # Continue even if tests fail

    - name: ðŸ“Š Check generated reports
      run: |
        echo "Checking for generated reports..."
        echo "ðŸ“ Directory listing:"
        ls -la
        
        echo "ðŸŽ­ Playwright reports:"
        if [ -d "playwright-report" ]; then
          echo "Found playwright-report directory"
          ls -la playwright-report/
        else
          echo "No playwright-report directory"
        fi
        
        echo "ðŸ“¸ Test artifacts:"
        if [ -d "test-results" ]; then
          echo "Found test-results directory"
          ls -la test-results/
        else
          echo "No test-results directory"
        fi

    - name: ðŸ“¤ Upload Playwright HTML report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-html-report
        path: playwright-report/
        retention-days: 7

    - name: ðŸ“¤ Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-artifacts
        path: |
          test-results/
          screenshots/
          videos/
          traces/
        retention-days: 7

    - name: ðŸ“‹ Create job summary
      if: always()
      run: |
        echo "## ðŸŽ­ Playwright CI Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow:** [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Available Reports:" >> $GITHUB_STEP_SUMMARY
        echo "- **Playwright HTML Report** - Download the 'playwright-html-report' artifact" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Artifacts** - Screenshots, videos, traces in 'test-artifacts'" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” How to view:" >> $GITHUB_STEP_SUMMARY
        echo "1. Go to this workflow run" >> $GITHUB_STEP_SUMMARY
        echo "2. Click on 'playwright-tests' job" >> $GITHUB_STEP_SUMMARY
        echo "3. In the 'Artifacts' section, download the reports" >> $GITHUB_STEP_SUMMARY
        echo "4. Extract and open `index.html` in a browser" >> $GITHUB_STEP_SUMMARY
