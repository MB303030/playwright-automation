name: Playwright Tests with Allure Report

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Docker check
      - name: ‚úÖ Verify Docker
        run: |
          docker --version
          echo "‚úÖ Docker is ready"
      
      # 2. Checkout
      - uses: actions/checkout@v4
      
      # 3. Setup Node
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # 4. Install
      - run: npm ci
      - run: npm install allure-playwright --save-dev
      - run: npx playwright install chromium
      
      # 5. Install Allure CLI
      - name: Install Allure
        run: |
          sudo apt update
          sudo apt install -y default-jre
          curl -Lo allure.tgz https://github.com/allure-framework/allure2/releases/download/2.24.1/allure-2.24.1.tgz
          tar -xzf allure.tgz -C ~/
          echo "$HOME/allure-2.24.1/bin" >> $GITHUB_PATH
      
      # 6. Run tests
      - name: Run tests
        continue-on-error: true
        run: npx playwright test --reporter=allure-playwright
      
      # 7. Generate report in MAIN branch
      - name: Generate and deploy report
        if: always()
        run: |
          # Generate report
          allure generate allure-results -o allure-report --clean
          
          # Create report in /reports folder in main branch
          mkdir -p reports
          cp -r allure-report/* reports/
          
          # Add simple index at root too
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head><title>Test Reports</title></head>
          <body>
            <h1>üéØ Test Reports</h1>
            <p><a href="/reports/">View Allure Report</a></p>
            <p><a href="https://github.com/${{ github.repository }}/actions">View Workflow Runs</a></p>
          </body>
          </html>
          EOF
          
          echo "üìä Report ready in /reports folder"
      
      # 8. Commit to main branch
      - name: Deploy to main branch
        if: always() && github.ref == 'refs/heads/main'
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add reports/ index.html
          git commit -m "Deploy Allure report $(date)" || echo "No changes to commit"
          git push origin main
      
      # 9. Show the link
      - name: Show report link
        if: always()
        run: |
          echo "=========================================="
          echo "           üìä ALLURE REPORT READY          "
          echo "=========================================="
          echo ""
          echo "üåê ONLINE REPORT:"
          echo "https://mb303030.github.io/playwright-automation/reports/"
          echo ""
          echo "üìÅ IN REPOSITORY:"
          echo "https://github.com/MB303030/playwright-automation/tree/main/reports"
          echo ""
          echo "‚öôÔ∏è Enable GitHub Pages:"
          echo "1. Go to: https://github.com/MB303030/playwright-automation/settings/pages"
          echo "2. Source: Deploy from a branch"
          echo "3. Branch: main"
          echo "4. Folder: / (root)"
          echo "5. Click Save"
          echo "=========================================="
