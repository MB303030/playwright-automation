name: Playwright Tests with Performance Graphs
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
    
    # 1. Install everything
    - name: Install dependencies
      run: |
        npm ci
        npm install -g @lhci/cli lighthouse
        
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    
    # 2. Run your existing tests
    - name: Run Playwright tests
      run: npx playwright test --reporter=html
    
    # 3. ⭐⭐ REAL PERFORMANCE GRAPHS ⭐⭐
    - name: Run Lighthouse Performance Tests
      run: |
        # Create a simple test to run Lighthouse on
        cat > lighthouse-test.js << 'EOF'
        const { chromium } = require('playwright');
        (async () => {
          const browser = await chromium.launch();
          const page = await browser.newPage();
          await page.goto('https://your-site.com');
          await browser.close();
        })();
        EOF
        
        node lighthouse-test.js
        
        # Run Lighthouse CI (creates real graphs)
        lhci autorun --upload.target=temporary-public-storage
    
    # 4. Upload everything
    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: test-results
        path: |
          playwright-report/
          .lighthouseci/
        retention-days: 30
