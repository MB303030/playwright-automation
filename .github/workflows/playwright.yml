# .github/workflows/playwright-ci.yml
name: Playwright CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual trigger

jobs:
  # Validate Docker installation
  validate-docker:
    runs-on: ubuntu-latest
    outputs:
      docker_available: ${{ steps.check-docker.outputs.available }}
    steps:
      - name: ðŸ” Check Docker installation
        id: check-docker
        run: |
          if docker --version > /dev/null 2>&1; then
            echo "âœ… Docker is available"
            echo "Docker version: $(docker --version)"
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Docker is NOT available - tests requiring Docker will be skipped"
            echo "available=false" >> $GITHUB_OUTPUT
          fi

  # Run Playwright tests with CI config
  playwright-tests:
    runs-on: ubuntu-latest
    needs: validate-docker
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸŽ­ Install Playwright browsers
      run: |
        echo "Installing Playwright browsers..."
        npx playwright install --with-deps chromium
        npx playwright install webkit  # For mobile tests
        npx playwright install firefox  # Optional

    - name: ðŸ”§ List files for debugging
      run: |
        echo "=== ðŸ“ FILE STRUCTURE ==="
        echo "Current directory: $(pwd)"
        echo ""
        echo "Root files:"
        ls -la
        echo ""
        echo "Config files:"
        ls -la playwright*.config.js || echo "No config files found"
        echo ""
        echo "Test directory:"
        ls -la tests/ || echo "No tests directory"
        echo "=== END ==="

    - name: ðŸ§ª Run Playwright tests
      env:
        DOCKER_AVAILABLE: ${{ needs.validate-docker.outputs.docker_available }}
      run: |
        echo "=== ðŸ§ª TEST EXECUTION ==="
        echo "Docker available: $DOCKER_AVAILABLE"
        
        # Run tests with CI config
        echo "Running Playwright tests..."
        npx playwright test --config=playwright.ci.config.js
      continue-on-error: true  # Continue even if tests fail

    - name: ðŸ” Locate and organize artifacts
      if: always()
      run: |
        echo "=== ðŸ” ARTIFACT LOCATION ==="
        
        # Create a summary file of all artifacts
        echo "# ðŸ“Š Artifact Locations" > artifact-locations.md
        echo "Generated: $(date)" >> artifact-locations.md
        echo "" >> artifact-locations.md
        
        # Check for screenshots
        echo "## ðŸ“¸ Screenshots" >> artifact-locations.md
        if find . -name "*.png" -type f | grep -q "."; then
          find . -name "*.png" -type f | head -20 | while read file; do
            echo "- \`$file\`" >> artifact-locations.md
          done
          echo "âœ… Screenshots found"
        else
          echo "- No screenshots found" >> artifact-locations.md
          echo "âŒ No screenshots"
        fi
        
        # Check for videos
        echo "" >> artifact-locations.md
        echo "## ðŸŽ¥ Videos" >> artifact-locations.md
        if find . -name "*.webm" -o -name "*.mp4" | grep -q "."; then
          find . -name "*.webm" -o -name "*.mp4" | head -20 | while read file; do
            echo "- \`$file\`" >> artifact-locations.md
          done
          echo "âœ… Videos found"
        else
          echo "- No videos found" >> artifact-locations.md
          echo "âŒ No videos"
        fi
        
        # Check for trace files
        echo "" >> artifact-locations.md
        echo "## ðŸ” Trace Files" >> artifact-locations.md
        if find . -name "trace.zip" -type f | grep -q "."; then
          find . -name "trace.zip" -type f | head -20 | while read file; do
            echo "- \`$file\`" >> artifact-locations.md
          done
          echo "âœ… Trace files found"
        else
          echo "- No trace files found" >> artifact-locations.md
          echo "âŒ No trace files"
        fi
        
        # Copy all artifacts to a central location for easy download
        echo ""
        echo "=== ðŸ“¦ ORGANIZING ARTIFACTS ==="
        mkdir -p all-artifacts
        mkdir -p all-artifacts/screenshots
        mkdir -p all-artifacts/videos
        mkdir -p all-artifacts/traces
        
        # Find and copy screenshots
        find . -name "*.png" -type f -exec cp {} all-artifacts/screenshots/ \; 2>/dev/null || true
        echo "Screenshots copied: $(ls all-artifacts/screenshots/ | wc -l)"
        
        # Find and copy videos
        find . -name "*.webm" -o -name "*.mp4" -type f -exec cp {} all-artifacts/videos/ \; 2>/dev/null || true
        echo "Videos copied: $(ls all-artifacts/videos/ | wc -l)"
        
        # Find and copy traces
        find . -name "trace.zip" -type f -exec cp {} all-artifacts/traces/ \; 2>/dev/null || true
        echo "Traces copied: $(ls all-artifacts/traces/ | wc -l)"
        
        # Show what we found
        echo ""
        echo "=== ðŸ“ FINAL ARTIFACT STRUCTURE ==="
        echo "all-artifacts/"
        find all-artifacts/ -type f | sort | head -30
        echo "=== END ==="

    - name: ðŸ“¤ Upload Playwright HTML report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-html-report
        path: playwright-report/
        retention-days: 7

    - name: ðŸ“¤ Upload ALL test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: all-test-artifacts
        path: |
          all-artifacts/
          test-results/
        retention-days: 7

    - name: ðŸ“¤ Upload organized artifacts by type
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: artifacts-by-type
        path: |
          all-artifacts/screenshots/
          all-artifacts/videos/
          all-artifacts/traces/
        retention-days: 7

    - name: ðŸ“¤ Upload Allure results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: allure-results
        path: allure-results/
        retention-days: 7

    - name: ðŸ“‹ Create detailed job summary
      if: always()
      run: |
        echo "## ðŸŽ­ Playwright CI Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow:** [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Docker Status:** ${{ needs.validate-docker.outputs.docker_available == 'true' && 'âœ… Available' || 'âŒ Not Available' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Show artifact counts if available
        if [ -d "all-artifacts" ]; then
          SCREENSHOTS_COUNT=$(find all-artifacts/screenshots/ -name "*.png" -type f 2>/dev/null | wc -l || echo 0)
          VIDEOS_COUNT=$(find all-artifacts/videos/ -name "*.webm" -o -name "*.mp4" 2>/dev/null | wc -l || echo 0)
          TRACES_COUNT=$(find all-artifacts/traces/ -name "*.zip" -type f 2>/dev/null | wc -l || echo 0)
          
          echo "### ðŸ“Š Generated Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "- **Screenshots:** $SCREENSHOTS_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Videos:** $VIDEOS_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Trace Files:** $TRACES_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "### ðŸ“ Available Downloads:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Artifact | What's Inside | How to Use |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|---------------|------------|" >> $GITHUB_STEP_SUMMARY
        echo "| **playwright-html-report** | Interactive HTML report | Download, extract, open `index.html` |" >> $GITHUB_STEP_SUMMARY
        echo "| **all-test-artifacts** | All raw test artifacts | Look in `test-results/` for failed test folders |" >> $GITHUB_STEP_SUMMARY
        echo "| **artifacts-by-type** | Organized by type | `screenshots/`, `videos/`, `traces/` folders |" >> $GITHUB_STEP_SUMMARY
        echo "| **allure-results** | Allure test data | Generate report with `allure generate` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ” How to Debug Failed Tests:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. **Download artifacts** from this workflow run" >> $GITHUB_STEP_SUMMARY
        echo "2. **Locate failed test artifacts:**" >> $GITHUB_STEP_SUMMARY
        echo "   - Screenshots: Look in `all-artifacts/screenshots/` or `test-results/[test-name]/`" >> $GITHUB_STEP_SUMMARY
        echo "   - Videos: Look in `all-artifacts/videos/` or `test-results/[test-name]/`" >> $GITHUB_STEP_SUMMARY
        echo "   - Trace files: Look in `all-artifacts/traces/` or `test-results/[test-name]/`" >> $GITHUB_STEP_SUMMARY
        echo "3. **View trace files:**" >> $GITHUB_STEP_SUMMARY
        echo "   ```bash" >> $GITHUB_STEP_SUMMARY
        echo "   npx playwright show-trace path/to/trace.zip" >> $GITHUB_STEP_SUMMARY
        echo "   ```" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Artifact Storage Locations:" >> $GITHUB_STEP_SUMMARY
        echo "- Playwright default: `test-results/[project]/[test-name]/`" >> $GITHUB_STEP_SUMMARY
        echo "- Organized copy: `all-artifacts/[type]/`" >> $GITHUB_STEP_SUMMARY
        echo "- HTML report: `playwright-report/index.html`" >> $GITHUB_STEP_SUMMARY
