# .github/workflows/playwright-ci.yml
name: Playwright CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # PHASE 1: SETUP & VALIDATION
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  checkout-code:
    runs-on: ubuntu-latest
    outputs:
      commit_hash: ${{ steps.get-commit.outputs.hash }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ” Get commit info
        id: get-commit
        run: |
          echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

  setup-node:
    runs-on: ubuntu-latest
    needs: checkout-code
    outputs:
      node_version: ${{ steps.check-node.outputs.version }}
    steps:
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: ðŸ” Verify Node.js
        id: check-node
        run: |
          echo "version=$(node --version)" >> $GITHUB_OUTPUT

  install-dependencies:
    runs-on: ubuntu-latest
    needs: [checkout-code, setup-node]
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ðŸ“¦ Install npm dependencies
        run: |
          echo "Installing dependencies..."
          npm ci
          echo "âœ… Dependencies installed"

  validate-docker:
    runs-on: ubuntu-latest
    needs: setup-node
    outputs:
      docker_available: ${{ steps.check-docker.outputs.available }}
    steps:
      - name: ðŸ” Check Docker
        id: check-docker
        run: |
          if docker --version > /dev/null 2>&1; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "available=false" >> $GITHUB_OUTPUT
          fi

  install-playwright:
    runs-on: ubuntu-latest
    needs: [checkout-code, setup-node, install-dependencies]
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ðŸ“¦ Install dependencies
        run: npm ci
        
      - name: ðŸŽ­ Install Playwright browsers
        run: |
          echo "Installing browsers..."
          npx playwright install chromium webkit firefox
          echo "âœ… Browsers installed"

  validate-config:
    runs-on: ubuntu-latest
    needs: [checkout-code, install-dependencies]
    outputs:
      test_count: ${{ steps.check-config.outputs.test_count }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Install dependencies
        run: npm ci
        
      - name: ðŸ”§ Validate config
        id: check-config
        run: |
          TEST_COUNT=$(find tests -name "*.spec.js" 2>/dev/null | wc -l)
          echo "test_count=$TEST_COUNT" >> $GITHUB_OUTPUT

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # PHASE 2: TEST EXECUTION
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  run-tests:
    runs-on: ubuntu-latest
    needs: [
      checkout-code,
      setup-node,
      install-dependencies,
      validate-docker,
      install-playwright,
      validate-config
    ]
    outputs:
      test_status: ${{ steps.run.outputs.status }}
    steps:
      - name: ðŸ“Š Pre-test summary
        run: |
          echo "=== ðŸš€ STARTING TESTS ==="
          echo "Test files: ${{ needs.validate-config.outputs.test_count }}"
          echo "Docker: ${{ needs.validate-docker.outputs.docker_available }}"
          
      - name: ðŸ§ª Run Playwright tests
        id: run
        run: |
          echo "Running tests..."
          npx playwright test --config=playwright.ci.config.js && echo "status=passed" >> $GITHUB_OUTPUT || echo "status=failed" >> $GITHUB_OUTPUT
        continue-on-error: true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # PHASE 3: ARTIFACT COLLECTION
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  collect-artifacts:
    runs-on: ubuntu-latest
    needs: run-tests
    if: always()
    outputs:
      screenshots_count: ${{ steps.collect.outputs.screenshots }}
      videos_count: ${{ steps.collect.outputs.videos }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: ðŸ“¦ Install dependencies
        run: npm ci
        
      - name: ðŸ§ª Run tests (to generate artifacts)
        run: |
          echo "Generating test artifacts..."
          npx playwright test --config=playwright.ci.config.js || true
        continue-on-error: true
        
      - name: ðŸ“¦ Collect artifacts
        id: collect
        run: |
          echo "Collecting artifacts..."
          
          # Count screenshots
          SCREENSHOTS=$(find . -name "*.png" -type f | wc -l)
          echo "screenshots=$SCREENSHOTS" >> $GITHUB_OUTPUT
          
          # Count videos
          VIDEOS=$(find . -name "*.webm" -type f | wc -l)
          echo "videos=$VIDEOS" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¸ Screenshots: $SCREENSHOTS"
          echo "ðŸŽ¥ Videos: $VIDEOS"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # PHASE 4: RESULT UPLOAD
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  upload-results:
    runs-on: ubuntu-latest
    needs: [run-tests, collect-artifacts]
    if: always()
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: ðŸ“¦ Install dependencies
        run: npm ci
        
      - name: ðŸ§ª Run tests (to ensure artifacts exist)
        run: |
          echo "Running tests for artifacts..."
          npx playwright test --config=playwright.ci.config.js || true
        continue-on-error: true
        
      - name: ðŸ“¤ Upload HTML report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-html-report
          path: playwright-report/
          
      - name: ðŸ“¤ Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: test-results/
          
      - name: ðŸ“¤ Upload Allure results
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results/

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # PHASE 5: FINAL SUMMARY
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  create-summary:
    runs-on: ubuntu-latest
    needs: [run-tests, collect-artifacts, upload-results]
    if: always()
    steps:
      - name: ðŸ“‹ Create final summary
        run: |
          echo "# ðŸŽ­ Playwright CI - Complete Workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“Š Workflow Diagram" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "```mermaid" >> $GITHUB_STEP_SUMMARY
          echo "graph TD" >> $GITHUB_STEP_SUMMARY
          echo "    subgraph \"Phase 1: Setup & Validation\"" >> $GITHUB_STEP_SUMMARY
          echo "        A[ðŸ“¥ Checkout Code]" >> $GITHUB_STEP_SUMMARY
          echo "        A --> B[âš™ï¸ Setup Node.js]" >> $GITHUB_STEP_SUMMARY
          echo "        B --> C[ðŸ“¦ Install Dependencies]" >> $GITHUB_STEP_SUMMARY
          echo "        C --> D[ðŸ” Validate Docker]" >> $GITHUB_STEP_SUMMARY
          echo "        C --> E[ðŸŽ­ Install Playwright]" >> $GITHUB_STEP_SUMMARY
          echo "        C --> F[ðŸ”§ Validate Config]" >> $GITHUB_STEP_SUMMARY
          echo "    end" >> $GITHUB_STEP_SUMMARY
          echo "    " >> $GITHUB_STEP_SUMMARY
          echo "    subgraph \"Phase 2: Test Execution\"" >> $GITHUB_STEP_SUMMARY
          echo "        G[ðŸ§ª Run Tests]" >> $GITHUB_STEP_SUMMARY
          echo "    end" >> $GITHUB_STEP_SUMMARY
          echo "    " >> $GITHUB_STEP_SUMMARY
          echo "    subgraph \"Phase 3: Artifact Collection\"" >> $GITHUB_STEP_SUMMARY
          echo "        H[ðŸ“¦ Collect Artifacts]" >> $GITHUB_STEP_SUMMARY
          echo "    end" >> $GITHUB_STEP_SUMMARY
          echo "    " >> $GITHUB_STEP_SUMMARY
          echo "    subgraph \"Phase 4: Result Upload\"" >> $GITHUB_STEP_SUMMARY
          echo "        I[ðŸ“¤ Upload Results]" >> $GITHUB_STEP_SUMMARY
          echo "    end" >> $GITHUB_STEP_SUMMARY
          echo "    " >> $GITHUB_STEP_SUMMARY
          echo "    subgraph \"Phase 5: Final Summary\"" >> $GITHUB_STEP_SUMMARY
          echo "        J[ðŸ“‹ Create Summary]" >> $GITHUB_STEP_SUMMARY
          echo "    end" >> $GITHUB_STEP_SUMMARY
          echo "    " >> $GITHUB_STEP_SUMMARY
          echo "    D --> G" >> $GITHUB_STEP_SUMMARY
          echo "    E --> G" >> $GITHUB_STEP_SUMMARY
          echo "    F --> G" >> $GITHUB_STEP_SUMMARY
          echo "    G --> H" >> $GITHUB_STEP_SUMMARY
          echo "    H --> I" >> $GITHUB_STEP_SUMMARY
          echo "    I --> J" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“ˆ Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Job | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Setup** | ðŸ“¥ Checkout Code | âœ… | ${{ needs.checkout-code.outputs.commit_hash }}" >> $GITHUB_STEP_SUMMARY
          echo "| **Setup** | âš™ï¸ Setup Node.js | âœ… | ${{ needs.setup-node.outputs.node_version }}" >> $GITHUB_STEP_SUMMARY
          echo "| **Setup** | ðŸ“¦ Install Dependencies | âœ… | Completed" >> $GITHUB_STEP_SUMMARY
          echo "| **Setup** | ðŸ” Validate Docker | ${{ needs.validate-docker.outputs.docker_available == 'true' && 'âœ…' || 'âŒ' }} | ${{ needs.validate-docker.outputs.docker_available == 'true' && 'Available' || 'Not Available' }}" >> $GITHUB_STEP_SUMMARY
          echo "| **Setup** | ðŸŽ­ Install Playwright | âœ… | Browsers installed" >> $GITHUB_STEP_SUMMARY
          echo "| **Setup** | ðŸ”§ Validate Config | âœ… | ${{ needs.validate-config.outputs.test_count }} tests" >> $GITHUB_STEP_SUMMARY
          echo "| **Test** | ðŸ§ª Run Tests | ${{ needs.run-tests.outputs.test_status == 'passed' && 'âœ…' || 'âŒ' }} | ${{ needs.run-tests.outputs.test_status }}" >> $GITHUB_STEP_SUMMARY
          echo "| **Collect** | ðŸ“¦ Collect Artifacts | âœ… | ${{ needs.collect-artifacts.outputs.screenshots_count }} ðŸ“¸, ${{ needs.collect-artifacts.outputs.videos_count }} ðŸŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "| **Upload** | ðŸ“¤ Upload Results | âœ… | 3 artifacts uploaded" >> $GITHUB_STEP_SUMMARY
          echo "| **Summary** | ðŸ“‹ Create Summary | âœ… | This summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“ Download Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **playwright-html-report** - Interactive HTML report" >> $GITHUB_STEP_SUMMARY
          echo "2. **test-artifacts** - Screenshots, videos, traces" >> $GITHUB_STEP_SUMMARY
          echo "3. **allure-results** - Allure test data" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ” Debugging Guide" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If tests failed:" >> $GITHUB_STEP_SUMMARY
          echo "1. Check which **Phase** failed above" >> $GITHUB_STEP_SUMMARY
          echo "2. Click on the failed job to see logs" >> $GITHUB_STEP_SUMMARY
          echo "3. Download artifacts for screenshots/traces" >> $GITHUB_STEP_SUMMARY
          echo "4. Use: `npx playwright show-trace trace.zip`" >> $GITHUB_STEP_SUMMARY
