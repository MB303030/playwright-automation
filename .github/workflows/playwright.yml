# .github/workflows/playwright-ci.yml
name: Playwright CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # Step 1: Validate Node.js installation
  validate-node:
    runs-on: ubuntu-latest
    outputs:
      node_version: ${{ steps.check-node.outputs.version }}
      node_available: ${{ steps.check-node.outputs.available }}
    steps:
      - name: ðŸ” Check Node.js installation
        id: check-node
        run: |
          if node --version > /dev/null 2>&1; then
            NODE_VERSION=$(node --version)
            NPM_VERSION=$(npm --version)
            echo "âœ… Node.js is available"
            echo "Node: $NODE_VERSION"
            echo "npm: $NPM_VERSION"
            echo "version=$NODE_VERSION" >> $GITHUB_OUTPUT
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Node.js is NOT available"
            echo "available=false" >> $GITHUB_OUTPUT
          fi

  # Step 2: Validate Docker installation  
  validate-docker:
    runs-on: ubuntu-latest
    outputs:
      docker_available: ${{ steps.check-docker.outputs.available }}
      docker_version: ${{ steps.check-docker.outputs.version }}
    steps:
      - name: ðŸ” Check Docker installation
        id: check-docker
        run: |
          if docker --version > /dev/null 2>&1; then
            DOCKER_VERSION=$(docker --version)
            echo "âœ… Docker is available"
            echo "$DOCKER_VERSION"
            echo "version=$DOCKER_VERSION" >> $GITHUB_OUTPUT
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Docker is NOT available - tests requiring Docker will be skipped"
            echo "available=false" >> $GITHUB_OUTPUT
          fi

  # Step 3: Validate Playwright browsers
  validate-playwright:
    runs-on: ubuntu-latest
    needs: [validate-node, validate-docker]
    outputs:
      browsers_installed: ${{ steps.check-browsers.outputs.installed }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Check Playwright browsers
        id: check-browsers
        run: |
          echo "Checking installed Playwright browsers..."
          
          # Check if browsers are installed
          if npx playwright install --dry-run 2>&1 | grep -q "already installed"; then
            echo "âœ… Playwright browsers are already installed"
            echo "installed=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Some browsers may need installation"
            echo "installed=false" >> $GITHUB_OUTPUT
          fi

  # Step 4: Run Playwright tests
  playwright-tests:
    runs-on: ubuntu-latest
    needs: [validate-node, validate-docker, validate-playwright]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸŽ­ Install Playwright browsers
      run: |
        echo "Installing Playwright browsers..."
        npx playwright install --with-deps chromium
        npx playwright install webkit  # For mobile tests
        npx playwright install firefox  # Optional

    - name: ðŸ§ª Run Playwright tests
      env:
        NODE_VERSION: ${{ needs.validate-node.outputs.node_version }}
        DOCKER_AVAILABLE: ${{ needs.validate-docker.outputs.docker_available }}
        BROWSERS_INSTALLED: ${{ needs.validate-playwright.outputs.browsers_installed }}
      run: |
        echo "=== ðŸ§ª TEST EXECUTION ==="
        echo "Node.js: $NODE_VERSION"
        echo "Docker: $DOCKER_AVAILABLE"
        echo "Browsers: $BROWSERS_INSTALLED"
        echo ""
        
        # Run tests with CI config
        echo "Running Playwright tests..."
        npx playwright test --config=playwright.ci.config.js
      continue-on-error: true

    # ... [KEEP ALL YOUR EXISTING STEPS BELOW - artifact organization, uploads, summary]
    # Just update the summary to show validation results:

    - name: ðŸ“‹ Create detailed job summary
      if: always()
      run: |
        echo "## ðŸŽ­ Playwright CI Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow:** [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### âœ… Validation Results:" >> $GITHUB_STEP_SUMMARY
        echo "- **Node.js:** ${{ needs.validate-node.outputs.node_version || 'Not found' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Docker:** ${{ needs.validate-docker.outputs.docker_available == 'true' && 'âœ… Available' || 'âŒ Not Available' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Playwright Browsers:** ${{ needs.validate-playwright.outputs.browsers_installed == 'true' && 'âœ… Installed' || 'âš ï¸ Needs installation' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ... [KEEP THE REST OF YOUR EXISTING SUMMARY]
