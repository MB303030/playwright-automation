name: Playwright Tests by Category

on:
  workflow_dispatch:
    inputs:
      test-category:
        description: 'Which tests to run?'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - mobile
          - security
          - web
          - smoke
          - performance
      browser:
        description: 'Browser to use'
        required: false
        default: 'chromium'
        type: choice
        options:
          - chromium
          - firefox
          - webkit

jobs:
  playwright-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install --with-deps

      - name: ğŸ§ª Run Tests
        id: run-tests
        continue-on-error: true
        run: |
          set +e
          
          echo "=========================================="
          echo "ğŸš€ RUNNING PLAYWRIGHT TESTS"
          echo "=========================================="
          echo "Category: ${{ inputs['test-category'] }}"
          echo "Browser: ${{ inputs.browser }}"
          echo "=========================================="
          
          # Map browser input â†’ Playwright project
          PROJECT=""
          case "${{ inputs.browser }}" in
            chromium)
              PROJECT="chrome"
              echo "Using project: chrome (Desktop Chrome)"
              ;;
            firefox)
              PROJECT="firefox"
              echo "Using project: firefox (Desktop Firefox)"
              ;;
            webkit)
              PROJECT="mobile-safari"
              echo "Using project: mobile-safari (iPhone 12)"
              ;;
          esac
          
          TEST_PATH=""
          case "${{ inputs['test-category'] }}" in
            mobile)
              TEST_PATH="tests/mobile/"
              echo "Test path: tests/mobile/"
              ;;
            security)
              TEST_PATH="tests/security/"
              echo "Test path: tests/security/"
              ;;
            web)
              TEST_PATH="tests/web/"
              echo "Test path: tests/web/"
              ;;
            smoke)
              TEST_PATH="tests/Smoke/"
              echo "Test path: tests/Smoke/"
              ;;
            performance)
              TEST_PATH="tests/mobile/performance/"
              echo "Test path: tests/mobile/performance/"
              ;;
            all)
              TEST_PATH="tests/"
              echo "Test path: tests/ (ALL TESTS)"
              ;;
          esac
          
          echo "=========================================="
          echo "ğŸ“‹ TESTS TO BE EXECUTED:"
          echo "=========================================="
          
          # Show which test files will be run
          find "$TEST_PATH" -name "*.spec.js" -o -name "*.spec.ts" 2>/dev/null | while read file; do
            if [ -f "$file" ]; then
              echo "  âœ… $(basename "$file")"
            fi
          done
          
          echo "=========================================="
          echo "ğŸ”§ EXECUTING TESTS..."
          echo "=========================================="
          
          # Run the tests
          npx playwright test "$TEST_PATH" \
            --project="$PROJECT" \
            --reporter=html,line \
            --output=test-results/ \
            2>&1 | tee test-output.txt
          
          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          
          echo "=========================================="
          echo "ğŸ“Š TEST EXECUTION COMPLETE"
          echo "=========================================="

      - name: ğŸ“Š Generate Comprehensive Report
        if: always()
        run: |
          echo "# ğŸ­ PLAYWRIGHT TEST RESULTS" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Test Category:** ${{ inputs['test-category'] }}  " >> "$GITHUB_STEP_SUMMARY"
          echo "**Browser:** ${{ inputs.browser }}  " >> "$GITHUB_STEP_SUMMARY"
          echo "**Run ID:** ${{ github.run_id }}  " >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          
          EXIT_CODE=${{ steps.run-tests.outputs.exit_code }}
          
          if [ -f "test-output.txt" ]; then
            # Extract key metrics
            TOTAL_TESTS=$(grep -o "[0-9]\+ tests" test-output.txt | head -1 | grep -o "[0-9]\+" || echo "0")
            PASSED_TESTS=$(grep -o "[0-9]\+ passed" test-output.txt | head -1 | grep -o "[0-9]\+" || echo "0")
            FAILED_TESTS=$(grep -o "[0-9]\+ failed" test-output.txt | head -1 | grep -o "[0-9]\+" || echo "0")
            SKIPPED_TESTS=$(grep -o "[0-9]\+ skipped" test-output.txt | head -1 | grep -o "[0-9]\+" || echo "0")
            DURATION=$(grep -o "in [0-9]\+[\.][0-9]\+s" test-output.txt | tail -1 | sed 's/in //' || echo "0s")
            
            # Calculate pass rate
            if [ "$TOTAL_TESTS" -gt 0 ]; then
              PASS_RATE=$((PASSED_TESTS * 100 / TOTAL_TESTS))
            else
              PASS_RATE=0
            fi
            
            echo "## ğŸ“ˆ EXECUTION SUMMARY" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            
            if [ "$EXIT_CODE" = "0" ]; then
              echo "### âœ… ALL TESTS PASSED!" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "### âŒ TESTS FAILED" >> "$GITHUB_STEP_SUMMARY"
            fi
            echo "" >> "$GITHUB_STEP_SUMMARY"
            
            echo "| Metric | Value | Status |" >> "$GITHUB_STEP_SUMMARY"
            echo "|--------|-------|--------|" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Total Tests** | $TOTAL_TESTS | ğŸ“Š |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **âœ… Passed** | $PASSED_TESTS | $([ "$PASSED_TESTS" -gt 0 ] && echo "âœ…" || echo "â–") |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **âŒ Failed** | $FAILED_TESTS | $([ "$FAILED_TESTS" -eq 0 ] && echo "âœ…" || echo "âš ï¸") |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **â­ï¸ Skipped** | $SKIPPED_TESTS | â„¹ï¸ |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **â±ï¸ Duration** | $DURATION | ğŸ•’ |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **ğŸ“ˆ Pass Rate** | ${PASS_RATE}% | $([ "$PASS_RATE" -ge 90 ] && echo "ğŸ¯" || ([ "$PASS_RATE" -ge 70 ] && echo "âš ï¸" || echo "âŒ")) |" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            
            echo "## ğŸ“ TEST OUTPUT" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            
            # Show test execution details
            if [ "$FAILED_TESTS" -gt 0 ]; then
              echo "### ğŸ” FAILING TESTS" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
              grep -B2 -A1 "\[FAIL\]\|âœ—\|Ã—" test-output.txt | head -50 >> "$GITHUB_STEP_SUMMARY" || echo "No specific failure details found" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
            fi
            
            echo "### ğŸ“‹ COMPLETE OUTPUT" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            tail -150 test-output.txt >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            
          else
            echo "## âŒ NO TEST OUTPUT FOUND" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "The test output file (test-output.txt) was not generated." >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
          fi
          
          # List test files in category
          echo "## ğŸ“ TEST FILES IN CATEGORY" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          
          TEST_PATH=""
          case "${{ inputs['test-category'] }}" in
            mobile)
              TEST_PATH="tests/mobile/"
              ;;
            security)
              TEST_PATH="tests/security/"
              ;;
            web)
              TEST_PATH="tests/web/"
              ;;
            smoke)
              TEST_PATH="tests/Smoke/"
              ;;
            performance)
              TEST_PATH="tests/mobile/performance/"
              ;;
            all)
              TEST_PATH="tests/"
              ;;
          esac
          
          find "$TEST_PATH" -name "*.spec.js" -o -name "*.spec.ts" 2>/dev/null | sort | while read file; do
            if [ -f "$file" ]; then
              echo "- **$(basename "$file")**  " >> "$GITHUB_STEP_SUMMARY"
              echo "  \`$file\`  " >> "$GITHUB_STEP_SUMMARY"
            fi
          done || echo "*No test files found in this category*" >> "$GITHUB_STEP_SUMMARY"
          
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## ğŸš€ NEXT STEPS" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          
          if [ "$EXIT_CODE" = "0" ]; then
            echo "âœ… **All tests passed successfully!**" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "1. **Download the HTML report** for detailed analysis" >> "$GITHUB_STEP_SUMMARY"
            echo "2. **Check performance metrics** in the report" >> "$GITHUB_STEP_SUMMARY"
            echo "3. **Proceed with deployment** - tests are âœ…" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âš ï¸ **Action required:**" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "1. **Download the HTML report** (includes screenshots & traces)" >> "$GITHUB_STEP_SUMMARY"
            echo "2. **Fix the $FAILED_TESTS failing test(s)**" >> "$GITHUB_STEP_SUMMARY"
            echo "3. **Check the failing tests section above**" >> "$GITHUB_STEP_SUMMARY"
            echo "4. **Re-run tests after fixes**" >> "$GITHUB_STEP_SUMMARY"
          fi
          
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "*Report generated: $(date)*" >> "$GITHUB_STEP_SUMMARY"

      - name: ğŸ“ Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ inputs['test-category'] }}-${{ github.run_id }}
          path: |
            playwright-report/
            test-output.txt
            test-results/
          retention-days: 14

      - name: ğŸ“Š Upload JSON Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ inputs['test-category'] }}-${{ github.run_id }}
          path: |
            test-results/
          retention-days: 30

      - name: ğŸš¨ Fail if Tests Failed
        if: always()
        run: |
          EXIT_CODE=${{ steps.run-tests.outputs.exit_code }}
          
          if [ "$EXIT_CODE" != "0" ]; then
            echo ""
            echo "=========================================="
            echo "âŒ TESTS FAILED"
            echo "=========================================="
            echo ""
            echo "ğŸ“Š Test run completed with failures."
            echo "ğŸ“¥ Download the HTML report for detailed analysis."
            echo "ğŸ” Check the GitHub summary above for specific failures."
            echo ""
            echo "=========================================="
            exit 1
          else
            echo ""
            echo "=========================================="
            echo "âœ… ALL TESTS PASSED"
            echo "=========================================="
            echo ""
            echo "ğŸ‰ Excellent! All tests completed successfully."
            echo "ğŸ“¥ HTML report available for download."
            echo ""
            echo "=========================================="
          fi
