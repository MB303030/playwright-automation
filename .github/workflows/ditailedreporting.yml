name: Playwright Tests by Category

on:
  workflow_dispatch:
    inputs:
      test-category:
        description: 'Which tests to run?'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - mobile
          - security
          - web
          - smoke
          - performance
      browser:
        description: 'Browser to use'
        required: false
        default: 'chromium'
        type: choice
        options:
          - chromium
          - firefox
          - webkit

jobs:
  playwright-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install --with-deps

      - name: ğŸ§ª Run Tests
        id: run-tests
        continue-on-error: true
        run: |
          set +e

          echo "Running ${{ inputs['test-category'] }} tests on ${{ inputs.browser }}..."

          # Map browser input â†’ Playwright project
          case "${{ inputs.browser }}" in
            chromium) PROJECT="chrome" ;;
            firefox)  PROJECT="firefox" ;;
            webkit)   PROJECT="mobile-safari" ;;
          esac

          # Map category â†’ real folder structure
          case "${{ inputs['test-category'] }}" in
            mobile)       TEST_PATH="tests/mobile/" ;;
            security)     TEST_PATH="tests/security/" ;;
            web)          TEST_PATH="tests/web/" ;;
            smoke)        TEST_PATH="tests/web/Smoke/" ;;
            performance)  TEST_PATH="tests/performance/Web/" ;;
            all)          TEST_PATH="tests/" ;;
          esac

          echo "Using project: $PROJECT"
          echo "Using test path: $TEST_PATH"

          npx playwright test "$TEST_PATH" \
            --project="$PROJECT" \
            --reporter=line,html,json \
            --output=test-results/ \
            --reporter=json=test-results/results.json \
            2>&1 | tee test-output.txt

          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"

      - name: ğŸ“Š Show Test Metrics & Results
        if: always()
        run: |
          echo "# ğŸ­ Playwright Test Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "**Category:** ${{ inputs['test-category'] }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Browser:** ${{ inputs.browser }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ -f "test-results/results.json" ]; then
            node <<'EOF'
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('test-results/results.json', 'utf8'));

            let total = 0, passed = 0, failed = 0, skipped = 0;

            for (const suite of data.suites || []) {
              for (const spec of suite.specs || []) {
                for (const test of spec.tests || []) {
                  total++;
                  const status = test.results[0]?.status;
                  if (status === 'passed') passed++;
                  else if (status === 'failed') failed++;
                  else if (status === 'skipped') skipped++;
                }
              }
            }

            const summary = `
| Metric | Count |
|-------|-------|
| Total Tests | ${total} |
| âœ… Passed | ${passed} |
| âŒ Failed | ${failed} |
| â­ Skipped | ${skipped} |
`;

            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary);
            EOF
          else
            echo "âš ï¸ No JSON results found." >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## ğŸ“ Console Output (last 100 lines)" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          tail -100 test-output.txt >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "ğŸ“¦ Download the **HTML report** from workflow artifacts." >> "$GITHUB_STEP_SUMMARY"

      - name: ğŸ“ Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ inputs['test-category'] }}-${{ github.run_id }}
          path: |
            playwright-report/
            test-output.txt
            test-results/
          retention-days: 7

      - name: ğŸš¨ Fail if Tests Failed
        if: always()
        run: |
          if [ "${{ steps.run-tests.outputs.exit_code }}" != "0" ]; then
            echo "Some tests failed."
            exit 1
          fi
