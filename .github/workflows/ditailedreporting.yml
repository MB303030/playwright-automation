name: Test Suite

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  CI: true
  FORCE_COLOR: 1
  NODE_ENV: test

jobs:
  test-all:
    timeout-minutes: 90
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chrome]  # Add 'firefox', 'webkit' if needed
    name: Playwright Tests (${{ matrix.browser }})
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
        npx playwright install --with-deps ${{ matrix.browser }}
    
    - name: Run Web Tests
      id: web-tests
      continue-on-error: true
      run: |
        echo "ðŸ”µ Running Web Tests..."
        npx playwright test ./tests/web \
          --reporter=html,allure-playwright \
          --project=${{ matrix.browser }} \
          --retries=1 \
          --workers=4 \
          --timeout=60000 \
          --trace=on \
          --video=on-first-retry \
          --screenshot=on \
          --shard=1/1
      env:
        TEST_TYPE: "web"
        BROWSER: ${{ matrix.browser }}
    
    - name: Run Mobile Tests
      id: mobile-tests
      continue-on-error: true
      run: |
        echo "ðŸ“± Running Mobile Tests..."
        npx playwright test ./tests/mobile \
          --reporter=html,allure-playwright \
          --project=${{ matrix.browser }} \
          --retries=2 \
          --workers=2 \
          --timeout=90000 \
          --trace=on \
          --video=on-first-retry \
          --screenshot=on \
          --shard=1/1
      env:
        TEST_TYPE: "mobile"
        BROWSER: ${{ matrix.browser }}
    
    - name: Run Performance Tests
      id: performance-tests
      continue-on-error: true
      run: |
        echo "âš¡ Running Performance Tests..."
        npx playwright test ./tests/performance \
          --reporter=html,allure-playwright \
          --project=${{ matrix.browser }} \
          --retries=0 \
          --workers=1 \
          --timeout=120000 \
          --trace=on \
          --video=on \
          --screenshot=on
      env:
        TEST_TYPE: "performance"
        BROWSER: ${{ matrix.browser }}
    
    - name: Generate Allure Report
      if: always()
      run: |
        echo "ðŸ“Š Generating Allure Report..."
        npx allure generate allure-results --clean -o allure-report
        
        # Create summary file for GitHub Actions
        echo "# Test Execution Summary" > test-summary.md
        echo "## Browser: ${{ matrix.browser }}" >> test-summary.md
        echo "### Test Results:" >> test-summary.md
        echo "- âœ… Web Tests: ${{ steps.web-tests.outcome }}" >> test-summary.md
        echo "- ðŸ“± Mobile Tests: ${{ steps.mobile-tests.outcome }}" >> test-summary.md
        echo "- âš¡ Performance Tests: ${{ steps.performance-tests.outcome }}" >> test-summary.md
        echo "" >> test-summary.md
        echo "Reports available in artifacts." >> test-summary.md
    
    - name: Archive Playwright HTML Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-html-report-${{ matrix.browser }}
        path: playwright-report/
        retention-days: 30
    
    - name: Archive Allure Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-report-${{ matrix.browser }}
        path: allure-report/
        retention-days: 30
    
    - name: Archive Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.browser }}
        path: |
          test-results/
          blob-report/
          allure-results/
        retention-days: 30
    
    - name: Upload Test Summary
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-summary-${{ matrix.browser }}
        path: test-summary.md
        retention-days: 30
    
    - name: Display Test Summary
      if: always()
      run: |
        echo "=== TEST EXECUTION SUMMARY ==="
        echo "Browser: ${{ matrix.browser }}"
        echo "Web Tests: ${{ steps.web-tests.outcome }}"
        echo "Mobile Tests: ${{ steps.mobile-tests.outcome }}"
        echo "Performance Tests: ${{ steps.performance-tests.outcome }}"
        echo "=============================="
    
    - name: Notify on Failure
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: "âŒ Tests failed on ${{ matrix.browser }}"
        channel: '#builds'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  generate-summary:
    needs: test-all
    runs-on: ubuntu-latest
    if: always()
    name: Generate Combined Report
    steps:
    - name: Download All Reports
      uses: actions/download-artifact@v4
      with:
        path: ./all-reports
    
    - name: Create Combined Summary
      run: |
        echo "# ðŸ§ª Combined Test Report" > combined-summary.md
        echo "" >> combined-summary.md
        echo "## ðŸ“ Available Reports:" >> combined-summary.md
        echo "" >> combined-summary.md
        
        # List all reports
        for report in ./all-reports/*; do
          echo "### $(basename $report)" >> combined-summary.md
          echo "- [Download]($(basename $report))" >> combined-summary.md
          echo "" >> combined-summary.md
        done
        
        echo "---" >> combined-summary.md
        echo "*Report generated on $(date)*" >> combined-summary.md
    
    - name: Upload Combined Summary
      uses: actions/upload-artifact@v4
      with:
        name: combined-test-reports
        path: |
          ./all-reports/
          combined-summary.md
        retention-days: 30
