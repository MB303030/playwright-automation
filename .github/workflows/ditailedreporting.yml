name: Playwright Tests by Category

on:
  workflow_dispatch:
    inputs:
      test-category:
        description: 'Which tests to run?'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - mobile
          - security
          - web
          - smoke
          - performance
      browser:
        description: 'Browser to use'
        required: false
        default: 'chromium'
        type: choice
        options:
          - chromium
          - firefox
          - webkit

jobs:
  playwright-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install ${{ inputs.browser }} --with-deps

      - name: ğŸ§ª Run Tests
        id: run-tests
        continue-on-error: true
        run: |
          set -o pipefail

          echo "Running ${{ inputs['test-category'] }} tests on ${{ inputs.browser }}..."

          TEST_PATH=""
          case "${{ inputs['test-category'] }}" in
            mobile)
              TEST_PATH="tests/mobile/"
              ;;
            security)
              TEST_PATH="tests/security/"
              ;;
            web)
              TEST_PATH="tests/web/"
              ;;
            smoke)
              TEST_PATH="tests/Smoke/"
              ;;
            performance)
              TEST_PATH="tests/mobile/performance/"
              ;;
            all)
              TEST_PATH="tests/"
              ;;
          esac

          npx playwright test "$TEST_PATH" \
            --project=${{ inputs.browser }} \
            --reporter=html,line \
            --output=test-results/ \
            2>&1 | tee test-output.txt

          echo "exit_code=$?" >> "$GITHUB_OUTPUT"

      - name: ğŸ“Š Show Test Results
        if: always()
        run: |
          echo "# ğŸ­ Test Results - ${{ inputs['test-category'] }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ -f "test-output.txt" ]; then
            echo "## ğŸ“‹ Test Summary" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"

            tail -20 test-output.txt | grep -E "tests|passed|failed|skipped" >> "$GITHUB_STEP_SUMMARY" || true

            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "## ğŸ“ Full Output" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            tail -100 test-output.txt >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No test output found." >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## ğŸ“ Tests Executed" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          case "${{ inputs['test-category'] }}" in
            mobile)
              echo "Running mobile tests:" >> "$GITHUB_STEP_SUMMARY"
              find tests/mobile/ -name "*.spec.js" -o -name "*.spec.ts" | sed 's|^|- |' >> "$GITHUB_STEP_SUMMARY" || true
              ;;
            security)
              echo "Running security tests:" >> "$GITHUB_STEP_SUMMARY"
              find tests/security/ -name "*.spec.js" -o -name "*.spec.ts" | sed 's|^|- |' >> "$GITHUB_STEP_SUMMARY" || true
              ;;
            web)
              echo "Running web tests:" >> "$GITHUB_STEP_SUMMARY"
              find tests/web/ -name "*.spec.js" -o -name "*.spec.ts" | sed 's|^|- |' >> "$GITHUB_STEP_SUMMARY" || true
              ;;
            smoke)
              echo "Running smoke tests:" >> "$GITHUB_STEP_SUMMARY"
              find tests/Smoke/ -name "*.spec.js" -o -name "*.spec.ts" | sed 's|^|- |' >> "$GITHUB_STEP_SUMMARY" || true
              ;;
            all)
              echo "Running ALL tests:" >> "$GITHUB_STEP_SUMMARY"
              find tests/ -name "*.spec.js" -o -name "*.spec.ts" | sed 's|^|- |' >> "$GITHUB_STEP_SUMMARY" || true
              ;;
          esac

      - name: ğŸ“ Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ inputs['test-category'] }}-${{ github.run_id }}
          path: |
            playwright-report/
            test-output.txt
            test-results/
          retention-days: 7

      - name: ğŸš¨ Fail if Tests Failed
        if: always()
        run: |
          if [ "${{ steps.run-tests.outputs.exit_code }}" != "0" ]; then
            echo "Some tests failed. Check the report above or download the HTML report."
            exit 1
          fi
