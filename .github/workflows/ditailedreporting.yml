name: Tag

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [ main, master ]

jobs:
  playwright-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    # Define matrix for parallel test runs if needed
    strategy:
      matrix:
        # Optional: Run different test groups in parallel
        # shardIndex: [1, 2, 3, 4]
        # shardTotal: [4]
        project: ['chrome', 'mobile-chrome', 'firefox']  # Run each project separately
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: |
        npm ci
        npm list @playwright/test || npm install @playwright/test

    - name: ğŸ­ Install Playwright browsers
      run: npx playwright install --with-deps chromium firefox

    - name: ğŸ§ª Run Playwright tests
      id: playwright-tests
      continue-on-error: true  # Don't fail immediately, we'll handle it later
      run: |
        echo "ğŸš€ Running Playwright tests..."
        
        # Set project if using matrix, otherwise run all
        PROJECT_CMD=""
        if [ -n "${{ matrix.project }}" ]; then
          PROJECT_CMD="--project ${{ matrix.project }}"
        fi
        
        # Run tests and capture output
        npx playwright test $PROJECT_CMD \
          --reporter=html,line,json \
          --output=test-results/ \
          2>&1 | tee test-output.log
        
        # Save exit code
        echo "exit_code=$?" >> $GITHUB_OUTPUT
        
        # Basic metrics extraction
        if [ -f "test-results/report.json" ]; then
          TOTAL_TESTS=$(jq '.stats.total // 0' test-results/report.json)
          PASSED_TESTS=$(jq '.stats.expected // 0' test-results/report.json)
          FAILED_TESTS=$(jq '.stats.unexpected // 0' test-results/report.json)
          SKIPPED_TESTS=$(jq '.stats.skipped // 0' test-results/report.json)
          
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
          echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "skipped_tests=$SKIPPED_TESTS" >> $GITHUB_OUTPUT
          
          if [ "$TOTAL_TESTS" -gt 0 ]; then
            PASS_RATE=$((PASSED_TESTS * 100 / TOTAL_TESTS))
            echo "pass_rate=$PASS_RATE" >> $GITHUB_OUTPUT
          else
            echo "pass_rate=0" >> $GITHUB_OUTPUT
          fi
        fi

    - name: ğŸ“Š Generate Detailed Report
      if: always()
      run: |
        echo "# ğŸ­ Playwright Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Load metrics from outputs
        EXIT_CODE=${{ steps.playwright-tests.outputs.exit_code }}
        TOTAL_TESTS=${{ steps.playwright-tests.outputs.total_tests || 0 }}
        PASSED_TESTS=${{ steps.playwright-tests.outputs.passed_tests || 0 }}
        FAILED_TESTS=${{ steps.playwright-tests.outputs.failed_tests || 0 }}
        SKIPPED_TESTS=${{ steps.playwright-tests.outputs.skipped_tests || 0 }}
        PASS_RATE=${{ steps.playwright-tests.outputs.pass_rate || 0 }}
        
        # Overall status
        if [ "$EXIT_CODE" = "0" ]; then
          echo "## âœ… ALL TESTS PASSED!" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ‰ Great job! All tests completed successfully.**" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ TESTS FAILED" >> $GITHUB_STEP_SUMMARY
          echo "**${FAILED_TESTS} test(s) need attention.**" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Summary table
        echo "### ğŸ“Š Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Result |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Total Tests** | $TOTAL_TESTS |" >> $GITHUB_STEP_SUMMARY
        echo "| **âœ… Passed** | $PASSED_TESTS |" >> $GITHUB_STEP_SUMMARY
        echo "| **âŒ Failed** | $FAILED_TESTS |" >> $GITHUB_STEP_SUMMARY
        echo "| **â­ï¸ Skipped** | $SKIPPED_TESTS |" >> $GITHUB_STEP_SUMMARY
        echo "| **ğŸ“ˆ Pass Rate** | ${PASS_RATE}% |" >> $GITHUB_STEP_SUMMARY
        
        if [ -n "${{ matrix.project }}" ]; then
          echo "| **ğŸ·ï¸ Project** | ${{ matrix.project }} |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Show individual test results if JSON report exists
        if [ -f "test-results/report.json" ]; then
          echo "### ğŸ“‹ Test Results by Suite" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Use jq to parse and display test results
          if command -v jq &> /dev/null; then
            echo "| Suite | Test | Status | Duration | Tags |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|------|--------|----------|------|" >> $GITHUB_STEP_SUMMARY
            
            # Extract and format test results
            jq -r '
              .suites[]? | .title as $suite |
              .specs[]? | .title as $spec |
              .tests[]? | 
              .results[-1] as $result |
              "| \($suite) | \($spec) | \($result.status) | \($result.duration)ms | \(.tags // [] | join(", ")) |"
            ' test-results/report.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "| *Error parsing detailed results* | | | | |" >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        # Show failing tests in detail
        if [ "$FAILED_TESTS" -gt 0 ]; then
          echo "### ğŸ” Failed Tests Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "test-output.log" ]; then
            echo "```" >> $GITHUB_STEP_SUMMARY
            # Extract just the failed test lines
            grep -A 3 -B 1 "\[FAIL\]\|âœ—\|Ã—" test-output.log | head -30 >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
          else
            echo "*Check the HTML report for detailed failure information.*" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Tag analysis
        if [ -f "test-results/report.json" ] && command -v jq &> /dev/null; then
          echo "### ğŸ·ï¸ Tag Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create temporary Python script for tag analysis
          python3 << 'EOF'
import json
import sys
from collections import defaultdict

try:
    with open('test-results/report.json', 'r') as f:
        data = json.load(f)
    
    tag_stats = defaultdict(lambda: {'total': 0, 'passed': 0, 'failed': 0, 'skipped': 0, 'duration': 0})
    
    def process_test(test, spec):
        last_result = test['results'][-1] if test.get('results') else {}
        status = last_result.get('status', 'unknown')
        duration = last_result.get('duration', 0)
        tags = spec.get('tags', []) or []
        
        if not tags:
            tags = ['@Untagged']
        
        for tag in tags:
            tag_stats[tag]['total'] += 1
            tag_stats[tag]['duration'] += duration
            if status == 'passed':
                tag_stats[tag]['passed'] += 1
            elif status == 'failed':
                tag_stats[tag]['failed'] += 1
            elif status == 'skipped':
                tag_stats[tag]['skipped'] += 1
    
    # Process all tests
    for suite in data.get('suites', []):
        for spec in suite.get('specs', []):
            for test in spec.get('tests', []):
                process_test(test, spec)
    
    # Print table
    print("| Tag | Total | âœ… Passed | âŒ Failed | â­ï¸ Skipped | ğŸ“ˆ Pass Rate |")
    print("|-----|-------|-----------|-----------|------------|--------------|")
    
    for tag, stats in sorted(tag_stats.items(), key=lambda x: x[1]['total'], reverse=True):
        total = stats['total']
        passed = stats['passed']
        failed = stats['failed']
        skipped = stats['skipped']
        pass_rate = round((passed / total) * 100, 1) if total > 0 else 0
        
        print(f"| {tag} | {total} | {passed} | {failed} | {skipped} | {pass_rate}% |")
    
except Exception as e:
    print(f"| *Error generating tag analysis: {str(e)}* | | | | |")
EOF
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Recommendations
        echo "### ğŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "$EXIT_CODE" = "0" ]; then
          echo "âœ… **All tests are passing! You can:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the HTML report for detailed analysis" >> $GITHUB_STEP_SUMMARY
          echo "2. Review tag performance above" >> $GITHUB_STEP_SUMMARY
          echo "3. Proceed with deployment" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Action required:**" >> $GITHUB_STEP_SUMMARY
          echo "1. **Download the HTML report** for screenshots & traces" >> $GITHUB_STEP_SUMMARY
          echo "2. **Fix the ${FAILED_TESTS} failing test(s)**" >> $GITHUB_STEP_SUMMARY
          echo "3. **Check the 'Failed Tests Details' section above**" >> $GITHUB_STEP_SUMMARY
          echo "4. **Re-run tests after fixes**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Report generated: $(date)*" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ“Š Upload HTML Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: |
          playwright-report/
          test-output.log
        retention-days: 14

    - name: ğŸ“ˆ Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: test-results/
        retention-days: 30

    - name: ğŸ“¤ Upload Test Output
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-output
        path: |
          test-output.log
          test-results/report.json
        retention-days: 30

    - name: ğŸš¨ Fail if tests failed
      if: failure() && steps.playwright-tests.outputs.exit_code != '0'
      run: |
        echo "âŒ Tests failed - check the report above for details"
        echo ""
        echo "To debug:"
        echo "1. Download the 'playwright-report' artifact"
        echo "2. Open index.html in your browser"
        echo "3. Check screenshots and traces for failing tests"
        exit 1
