name: main

on:
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'ðŸ“‚ Which test suite?'
        required: true
        type: choice
        options:
        - Smoke
        - Regression
        - Sanity
        - Negative
        default: 'Smoke'
      browser:
        description: 'ðŸŒ Browser to use'
        required: true
        type: choice
        options:
        - chrome
        - firefox
        - webkit
        default: 'chrome'

jobs:
  validate_and_trigger:
    runs-on: ubuntu-latest
    outputs:
      test_path: ${{ steps.validate.outputs.TEST_PATH }}
      run_id: ${{ steps.generate_id.outputs.run_id }}
      test_files_found: ${{ steps.validate.outputs.TEST_FILES_FOUND }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ†” Generate Run ID
        id: generate_id
        run: |
          RUN_ID="run_$(date +%Y%m%d_%H%M%S)"
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Generated Run ID: $RUN_ID"
      
      - name: ðŸ” Validate Test Path
        id: validate
        run: |
          echo "=== ðŸ” VALIDATING TEST PATH ==="
          
          # Set the test path based on input
          TEST_PATH="./tests/web/${{ github.event.inputs.test_suite }}"
          echo "Test Suite: ${{ github.event.inputs.test_suite }}"
          echo "Expected Path: $TEST_PATH"
          echo ""
          
          # Check if directory exists
          if [ ! -d "$TEST_PATH" ]; then
            echo "âŒ ERROR: Directory '$TEST_PATH' does not exist!"
            echo ""
            echo "Available test directories:"
            ls -la ./tests/web/ || echo "No tests/web directory found"
            exit 1
          fi
          
          echo "âœ… Directory exists!"
          echo ""
          echo "ðŸ“ Contents of $TEST_PATH:"
          ls -la "$TEST_PATH"
          
          # Count .spec.js files
          SPEC_COUNT=$(find "$TEST_PATH" -name "*.spec.js" -type f 2>/dev/null | wc -l)
          echo ""
          echo "ðŸ“Š Found $SPEC_COUNT .spec.js file(s)"
          
          if [ "$SPEC_COUNT" -eq 0 ]; then
            echo "âš ï¸ WARNING: No .spec.js files found"
            echo "Looking for any test files..."
            find "$TEST_PATH" -name "*.js" -type f 2>/dev/null | head -10
          fi
          
          # Save outputs
          echo "TEST_PATH=$TEST_PATH" >> $GITHUB_OUTPUT
          echo "TEST_FILES_FOUND=$SPEC_COUNT" >> $GITHUB_OUTPUT
      
      - name: ðŸ“‹ Print Configuration Summary
        run: |
          echo "=== âœ… CONFIGURATION SUMMARY ==="
          echo "Test Suite: ${{ github.event.inputs.test_suite }}"
          echo "Browser: ${{ github.event.inputs.browser }}"
          echo "Test Path: ${{ steps.validate.outputs.TEST_PATH }}"
          echo "Test Files Found: ${{ steps.validate.outputs.TEST_FILES_FOUND }}"
          echo "Run ID: ${{ steps.validate.outputs.run_id }}"
          echo "================================"

  execute_tests:
    needs: validate_and_trigger
    if: ${{ needs.validate_and_trigger.outputs.test_files_found != '0' }}
    uses: ./.github/workflows/test_runner.yml
    with:
      test_suite: ${{ github.event.inputs.test_suite }}
      browser: ${{ github.event.inputs.browser }}
      test_path: ${{ needs.validate_and_trigger.outputs.test_path }}
      run_id: ${{ needs.validate_and_trigger.outputs.run_id }}
    secrets: inherit

  generate_report:
    needs: execute_tests
    if: always()
    uses: ./.github/workflows/report_generator.yml
    with:
      test_suite: ${{ github.event.inputs.test_suite }}
      browser: ${{ github.event.inputs.browser }}
      run_id: ${{ needs.validate_and_trigger.outputs.run_id }}
    secrets: inherit
