name: main

on:
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'ðŸ“‚ Which test suite?'
        required: true
        type: choice
        options:
        - Smoke
        - Regression
        - Sanity
        - Negative
        default: 'Smoke'
      browser:
        description: 'ðŸŒ Browser to use'
        required: true
        type: choice
        options:
        - chrome
        - firefox
        - webkit
        default: 'chrome'

jobs:
  debug_and_run:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ†” Generate Run ID
        id: generate_id
        run: |
          RUN_ID="run_$(date +%Y%m%d_%H%M%S)"
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Generated Run ID: $RUN_ID"
      
      - name: ðŸ” Debug Inputs
        run: |
          echo "=== ðŸŽ¯ INPUT PARAMETERS ==="
          echo "Test Suite: ${{ github.event.inputs.test_suite }}"
          echo "Browser: ${{ github.event.inputs.browser }}"
          echo "==========================="
      
      - name: ðŸ“‚ Show Actual Project Structure
        run: |
          echo "=== ðŸ“ ACTUAL PROJECT STRUCTURE ==="
          echo "Listing ./tests/web directory:"
          ls -la ./tests/web/
          echo ""
          
          echo "Listing ./tests/web/${{ github.event.inputs.test_suite }} directory:"
          ls -la ./tests/web/${{ github.event.inputs.test_suite }}/ || echo "Directory not found"
          echo ""
          
          echo "=== ðŸ” FINDING TEST FILES ==="
          TEST_PATH="./tests/web/${{ github.event.inputs.test_suite }}"
          echo "Looking for test files in: $TEST_PATH"
          
          if [ ! -d "$TEST_PATH" ]; then
            echo "âŒ ERROR: Directory '$TEST_PATH' does not exist!"
            echo ""
            echo "Available directories in ./tests/web/:"
            ls -la ./tests/web/
            exit 1
          fi
          
          # Find all .spec.js files
          TEST_FILES=$(find "$TEST_PATH" -name "*.spec.js" -type f 2>/dev/null || true)
          
          if [ -z "$TEST_FILES" ]; then
            echo "âš ï¸ WARNING: No .spec.js files found in $TEST_PATH"
            echo "Looking for any .js files..."
            find "$TEST_PATH" -name "*.js" -type f 2>/dev/null || echo "No .js files found"
          else
            echo "âœ… Found test files:"
            echo "$TEST_FILES"
            echo ""
            echo "ðŸ“Š File count: $(echo "$TEST_FILES" | wc -l)"
          fi
      
      - name: ðŸ§ª Run Actual Playwright Tests
        id: run_tests
        run: |
          echo "=== ðŸš€ RUNNING ACTUAL TESTS ==="
          
          TEST_PATH="./tests/web/${{ github.event.inputs.test_suite }}"
          RUN_ID="${{ steps.generate_id.outputs.run_id }}"
          
          echo "Test Path: $TEST_PATH"
          echo "Run ID: $RUN_ID"
          echo "Browser: ${{ github.event.inputs.browser }}"
          
          # Map browser name for Playwright
          if [ "${{ github.event.inputs.browser }}" = "chrome" ]; then
            PROJECT="chromium"
          elif [ "${{ github.event.inputs.browser }}" = "firefox" ]; then
            PROJECT="firefox"
          elif [ "${{ github.event.inputs.browser }}" = "webkit" ]; then
            PROJECT="webkit"
          else
            PROJECT="chromium"
          fi
          
          # Create directories for reports
          HTML_REPORT_DIR="./playwright-report-html/$RUN_ID"
          TEST_RESULTS_DIR="./test-results/$RUN_ID"
          
          mkdir -p $HTML_REPORT_DIR
          mkdir -p $TEST_RESULTS_DIR
          
          echo ""
          echo "ðŸ“ HTML Report will be in: $HTML_REPORT_DIR"
          echo "ðŸ“ Test Results will be in: $TEST_RESULTS_DIR"
          
          # Check if we have package.json and Playwright
          if [ ! -f "package.json" ]; then
            echo "âŒ ERROR: No package.json found!"
            exit 1
          fi
          
          # Install dependencies if needed
          echo "ðŸ“¦ Checking dependencies..."
          npm list @playwright/test 2>/dev/null || npm install
          
          # Install browsers
          echo "ðŸ”§ Installing browsers..."
          npx playwright install --with-deps
          
          # Run the actual tests
          echo ""
          echo "ðŸ§ª Executing command:"
          echo "npx playwright test \"$TEST_PATH\" --project=$PROJECT --reporter=html,line --output=\"$TEST_RESULTS_DIR\""
          echo ""
          
          set +e
          npx playwright test \
            "$TEST_PATH" \
            --project="$PROJECT" \
            --reporter=html,line \
            --output="$TEST_RESULTS_DIR" \
            --retries=1
          TEST_EXIT_CODE=$?
          set -e
          
          echo ""
          echo "ðŸ“Š Test exit code: $TEST_EXIT_CODE"
          
          # Move HTML report to its own directory
          if [ -d "$TEST_RESULTS_DIR/playwright-report" ]; then
            mv "$TEST_RESULTS_DIR/playwright-report"/* "$HTML_REPORT_DIR/" 2>/dev/null || true
          fi
      
      - name: ðŸ“¦ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ steps.generate_id.outputs.run_id }}
          path: ./test-results/${{ steps.generate_id.outputs.run_id }}
          retention-days: 7
      
      - name: ðŸ“¦ Upload HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-html-report-${{ steps.generate_id.outputs.run_id }}
          path: ./playwright-report-html/${{ steps.generate_id.outputs.run_id }}
          retention-days: 7
      
      - name: ðŸ“Š Create Summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Test Suite: ${{ github.event.inputs.test_suite }}" >> $GITHUB_STEP_SUMMARY
          echo "- Browser: ${{ github.event.inputs.browser }}" >> $GITHUB_STEP_SUMMARY
          echo "- Run ID: ${{ steps.generate_id.outputs.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**Artifacts Available:**" >> $GITHUB_STEP_SUMMARY
          echo "1. **test-results-${{ steps.generate_id.outputs.run_id }}** - Raw test results" >> $GITHUB_STEP_SUMMARY
          echo "2. **playwright-html-report-${{ steps.generate_id.outputs.run_id }}** - HTML report (open index.html in browser)" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.run_tests.outcome }}" = "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Tests executed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Tests may have failed or encountered issues**" >> $GITHUB_STEP_SUMMARY
          fi
