name: Docker Playwright CI ON DEMAND

on:
  workflow_dispatch:

jobs:
  playwright-tests:
    runs-on: ubuntu-latest

    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 1: Environment Setup
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ” Check Docker (Phase 1.1)
      id: check-docker
      run: |
        echo "=== ðŸ” Docker Check ==="
        if command -v docker &> /dev/null; then
          echo "âœ… Docker: $(docker --version)"
          echo "docker_available=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ Docker not found"
          echo "docker_available=false" >> $GITHUB_OUTPUT
        fi

    - name: ðŸ“¥ Checkout code (Phase 1.2)
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js (Phase 1.3)
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 2: Dependencies & Tools
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸŸ© PHASE 2: Dependencies & Tools
      run: |
        echo "=== ðŸŸ© PHASE 2: Dependencies & Tools ==="
        echo ""
        echo "ðŸ“¦ Node.js: $(node --version)"
        echo "ðŸ“¦ npm: $(npm --version)"
        echo ""
        echo "ðŸ“¦ Installing dependencies..."
        npm ci
        echo "âœ… Dependencies installed"
        echo ""
        echo "ðŸŽ­ Installing Playwright browsers..."
        npx playwright install --with-deps chromium
        echo "âœ… Browsers installed"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 3: Debug & Validation
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸŸ¨ PHASE 3: Debug & Validation
      run: |
        echo "=== ðŸŸ¨ PHASE 3: Debug & Validation ==="
        echo "ðŸ”§ File structure:"
        pwd
        ls -la
        echo ""
        echo "âš™ï¸ Config files:"
        ls -la playwright*.config.js || echo "No config files"
        echo ""
        echo "ðŸ§ª Test files:"
        ls -la tests/ || echo "No tests directory"
        echo ""
        echo "ðŸ“Š Environment summary:"
        if [ "${{ steps.check-docker.outputs.docker_available }}" == "true" ]; then
          echo "- Docker: âœ…"
        else
          echo "- Docker: âš ï¸"
        fi
        echo "- Node.js: $(node --version)"
        echo "- npm: $(npm --version)"
        echo "- Playwright: $(npx playwright --version 2>/dev/null || echo 'Not found')"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 4: Test Execution
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸŸ¥ PHASE 4: Test Execution
      id: phase4
      run: |
        echo "=== ðŸŸ¥ PHASE 4: Test Execution ==="
        npx playwright test --config=playwright.ci.config.js
        EXIT_CODE=$?
        echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
        if [ $EXIT_CODE -eq 0 ]; then
          echo "tests_status=âœ…" >> $GITHUB_OUTPUT
        else
          echo "tests_status=âŒ" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 5: Report Analysis
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸŸª PHASE 5: Report Analysis
      id: phase5
      run: |
        echo "=== ðŸŸª PHASE 5: Report Analysis ==="
        # Playwright HTML report
        if [ -d "playwright-report" ] && [ -f "playwright-report/index.html" ]; then
          echo "report_exists=true" >> $GITHUB_OUTPUT
          echo "report_size=$(du -sh playwright-report | cut -f1)" >> $GITHUB_OUTPUT
        else
          echo "report_exists=false" >> $GITHUB_OUTPUT
        fi

        # Test artifacts
        if [ -d "test-results" ]; then
          echo "artifacts_exist=true" >> $GITHUB_OUTPUT
          echo "artifact_count=$(find test-results -type f | wc -l)" >> $GITHUB_OUTPUT
        else
          echo "artifacts_exist=false" >> $GITHUB_OUTPUT
          echo "artifact_count=0" >> $GITHUB_OUTPUT
        fi

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 6: Artifact Upload
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“¤ Upload Playwright HTML report
      if: steps.phase5.outputs.report_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: playwright-html-report
        path: playwright-report/
        retention-days: 7

    - name: ðŸ“¤ Upload test artifacts
      if: steps.phase5.outputs.artifacts_exist == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: test-artifacts
        path: test-results/
        retention-days: 7

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # FINAL SUMMARY
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“‹ Create Pipeline Summary
      run: |
        echo "## ðŸŽ­ Docker Playwright CI - Summary" >> $GITHUB_STEP_SUMMARY
        echo ""
        echo "| Phase | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”µ Environment | ${{ steps.check-docker.outputs.docker_available == 'true' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŸ¢ Dependencies | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŸ¡ Validation | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”´ Execution | ${{ steps.phase4.outputs.tests_status }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŸ£ Analysis | Report: ${{ steps.phase5.outputs.report_exists == 'true' && 'âœ…' || 'âŒ' }}, Artifacts: ${{ steps.phase5.outputs.artifact_count }} files |" >> $GITHUB_STEP_SUMMARY
        echo ""
        echo "### ðŸ“¥ Download Artifacts"
        echo "- Playwright HTML report: if available in 'playwright-html-report'"
        echo "- Test artifacts: if available in 'test-artifacts'"
