name: Playwright CI ON DEMAND extended report

on:
  workflow_dispatch:

jobs:
  playwright-tests:
    runs-on: ubuntu-latest
    
    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 1: SETUP
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      id: checkout
      
    - name: âš™ï¸ Setup Node.js with caching
      uses: actions/setup-node@v4
      id: node-setup
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies with cache
      uses: bahmutov/npm-install@v1
      id: npm-install
      with:
        useLockFile: true

    - name: ðŸŽ­ Install Playwright browsers
      id: browser-install
      run: npx playwright install --with-deps chromium

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 2: EXECUTION
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ”§ List files for debugging
      id: debug-files
      run: |
        echo "=== ðŸ“ FILE STRUCTURE ==="
        pwd
        ls -la
        echo "Node modules: $(find node_modules -type f | wc -l) files"
        echo "Playwright: $(which playwright)"

    - name: ðŸ§ª Run Playwright tests
      id: run-tests
      run: |
        echo "Running tests with CI config..."
        npx playwright test --config=playwright.ci.config.js
      continue-on-error: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 3: REPORTING
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“Š Check generated reports
      id: check-reports
      run: |
        echo "=== ðŸ“Š REPORT STATUS ==="
        echo ""
        echo "Playwright report:"
        if [ -d "playwright-report" ] && [ -f "playwright-report/index.html" ]; then
          echo "âœ… EXISTS - $(du -sh playwright-report)"
          echo "report_exists=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ MISSING"
          echo "report_exists=false" >> $GITHUB_OUTPUT
        fi
        
        echo ""
        echo "Test artifacts:"
        if [ -d "test-results" ]; then
          echo "âœ… EXISTS - $(du -sh test-results)"
          echo "artifacts_exist=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ MISSING"
          echo "artifacts_exist=false" >> $GITHUB_OUTPUT
        fi

    - name: ðŸ“¤ Upload Playwright HTML report
      id: upload-report
      if: steps.check-reports.outputs.report_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: playwright-html-report
        path: playwright-report/
        retention-days: 7

    - name: ðŸ“¤ Upload test artifacts
      id: upload-artifacts
      if: steps.check-reports.outputs.artifacts_exist == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: test-artifacts
        path: test-results/
        retention-days: 7

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 4: SUMMARY
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“‹ Create job summary
      if: always()
      run: |
        echo "## ðŸŽ­ Playwright CI - Execution Pipeline" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "```mermaid" >> $GITHUB_STEP_SUMMARY
        echo "graph TD" >> $GITHUB_STEP_SUMMARY
        echo "    A[ðŸ“¥ Checkout Code] --> B[âš™ï¸ Setup Node.js]" >> $GITHUB_STEP_SUMMARY
        echo "    B --> C[ðŸ“¦ Install Dependencies]" >> $GITHUB_STEP_SUMMARY
        echo "    C --> D[ðŸŽ­ Install Browsers]" >> $GITHUB_STEP_SUMMARY
        echo "    D --> E[ðŸ”§ Debug Files]" >> $GITHUB_STEP_SUMMARY
        echo "    E --> F[ðŸ§ª Run Tests]" >> $GITHUB_STEP_SUMMARY
        echo "    F --> G[ðŸ“Š Check Reports]" >> $GITHUB_STEP_SUMMARY
        echo "    G --> H{Report Exists?}" >> $GITHUB_STEP_SUMMARY
        echo "    H -->|Yes| I[ðŸ“¤ Upload Report]" >> $GITHUB_STEP_SUMMARY
        echo "    H -->|No| J[âš ï¸ No Report]" >> $GITHUB_STEP_SUMMARY
        echo "    G --> K{Artifacts Exist?}" >> $GITHUB_STEP_SUMMARY
        echo "    K -->|Yes| L[ðŸ“¤ Upload Artifacts]" >> $GITHUB_STEP_SUMMARY
        echo "    K -->|No| M[âš ï¸ No Artifacts]" >> $GITHUB_STEP_SUMMARY
        echo "    style A fill:#e1f5fe" >> $GITHUB_STEP_SUMMARY
        echo "    style B fill:#f3e5f5" >> $GITHUB_STEP_SUMMARY
        echo "    style C fill:#e8f5e8" >> $GITHUB_STEP_SUMMARY
        echo "    style D fill:#fff3e0" >> $GITHUB_STEP_SUMMARY
        echo "    style E fill:#fce4ec" >> $GITHUB_STEP_SUMMARY
        echo "    style F fill:#fff8e1" >> $GITHUB_STEP_SUMMARY
        echo "    style G fill:#e8eaf6" >> $GITHUB_STEP_SUMMARY
        echo "    style I fill:#c8e6c9" >> $GITHUB_STEP_SUMMARY
        echo "    style L fill:#bbdefb" >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“Š Step Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Phase | Step | Status | Output |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|------|--------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Setup** | ðŸ“¥ Checkout Code | âœ… | Branch: \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Setup** | âš™ï¸ Setup Node.js | âœ… | $(node --version) |" >> $GITHUB_STEP_SUMMARY
        echo "| **Setup** | ðŸ“¦ Install Dependencies | âœ… | Dependencies installed |" >> $GITHUB_STEP_SUMMARY
        echo "| **Setup** | ðŸŽ­ Install Browsers | âœ… | Chromium installed |" >> $GITHUB_STEP_SUMMARY
        echo "| **Setup** | ðŸ”§ Debug Files | âœ… | Files listed |" >> $GITHUB_STEP_SUMMARY
        echo "| **Execution** | ðŸ§ª Run Tests | ${{ steps.run-tests.outcome == 'success' && 'âœ…' || 'âŒ' }} | Exit code: ${{ steps.run-tests.outputs.exit_code || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Reporting** | ðŸ“Š Check Reports | ${{ steps.check-reports.outcome == 'success' && 'âœ…' || 'âŒ' }} | Report: ${{ steps.check-reports.outputs.report_exists == 'true' && 'Found' || 'Missing' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Reporting** | ðŸ“¤ Upload Report | ${{ steps.upload-report.outcome == 'success' && 'âœ…' || 'âš ï¸' }} | ${{ steps.upload-report.outcome == 'success' && 'Uploaded' || 'Skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Reporting** | ðŸ“¤ Upload Artifacts | ${{ steps.upload-artifacts.outcome == 'success' && 'âœ…' || 'âš ï¸' }} | ${{ steps.upload-artifacts.outcome == 'success' && 'Uploaded' || 'Skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸŽ¯ Final Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.check-reports.outputs.report_exists }}" = "true" ]; then
          echo "âœ… **SUCCESS**: Playwright HTML report generated and uploaded" >> $GITHUB_STEP_SUMMARY
          echo "- Download: **playwright-html-report** artifact" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **PARTIAL**: Tests ran but no HTML report was generated" >> $GITHUB_STEP_SUMMARY
          echo "- Check test execution logs for errors" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.check-reports.outputs.artifacts_exist }}" = "true" ]; then
          echo "- Debug: **test-artifacts** available for failed tests" >> $GITHUB_STEP_SUMMARY
        fi
