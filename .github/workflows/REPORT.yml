name: Playwright CI ON DEMAND version with tyable report

on:
  workflow_dispatch:  # Manual trigger ONLY

jobs:
  # Check Docker is available
  check-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Verify Docker installation
        run: |
          which docker || echo "âŒ Docker not found"
          docker --version
          echo "âœ… Docker check complete"

  # Run Playwright tests with CI config
  playwright-tests:
    runs-on: ubuntu-latest
    needs: check-docker
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸŽ­ Install Playwright browsers
      run: npx playwright install --with-deps chromium

    - name: ðŸ”§ List files for debugging
      run: |
        echo "Current directory:"
        pwd
        echo "Files in root:"
        ls -la
        echo "Config files:"
        ls -la playwright*.config.js || echo "No config files found"

    - name: ðŸ§ª Run Playwright tests (CI config)
      id: run-tests
      run: |
        echo "Running tests with CI config..."
        npx playwright test --config=playwright.ci.config.js
        
        # Capture exit code
        echo "exit_code=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: ðŸ“Š Check generated reports
      id: check-reports
      run: |
        echo "Checking for generated reports..."
        
        # Check Playwright report
        if [ -d "playwright-report" ] && [ -f "playwright-report/index.html" ]; then
          echo "playwright_report=true" >> $GITHUB_OUTPUT
          REPORT_SIZE=$(du -sh playwright-report | cut -f1)
          echo "playwright_report_size=$REPORT_SIZE" >> $GITHUB_OUTPUT
        else
          echo "playwright_report=false" >> $GITHUB_OUTPUT
          echo "playwright_report_size=0B" >> $GITHUB_OUTPUT
        fi
        
        # Check test artifacts
        if [ -d "test-results" ]; then
          echo "test_artifacts=true" >> $GITHUB_OUTPUT
          ARTIFACT_COUNT=$(find test-results -type f -name "*.png" -o -name "*.webm" -o -name "*.zip" 2>/dev/null | wc -l)
          echo "artifact_count=$ARTIFACT_COUNT" >> $GITHUB_OUTPUT
        else
          echo "test_artifacts=false" >> $GITHUB_OUTPUT
          echo "artifact_count=0" >> $GITHUB_OUTPUT
        fi

    - name: ðŸ“¤ Upload Playwright HTML report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-html-report
        path: playwright-report/
        retention-days: 7

    - name: ðŸ“¤ Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-artifacts
        path: |
          test-results/
        retention-days: 7

    - name: ðŸ“‹ Create job summary
      if: always()
      run: |
        echo "## ðŸŽ­ Playwright CI Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“‹ Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Step | Status | Details |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“¥ **Code Checkout** | âœ… Success | Branch: \`${{ github.ref_name }}\`<br>Commit: \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| âš™ï¸ **Node.js Setup** | âœ… Success | Version: $(node --version) |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“¦ **Dependencies** | âœ… Success | Installed with \`npm ci\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŽ­ **Browser Install** | âœ… Success | Chromium installed |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ§ª **Test Execution** | ${{ steps.run-tests.outputs.exit_code == '0' && 'âœ… Success' || 'âŒ Failed' }} | Exit code: ${{ steps.run-tests.outputs.exit_code || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“Š **Report Generation** | ${{ steps.check-reports.outputs.playwright_report == 'true' && 'âœ… Generated' || 'âŒ Failed' }} | Size: ${{ steps.check-reports.outputs.playwright_report_size }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“¸ **Test Artifacts** | ${{ steps.check-reports.outputs.test_artifacts == 'true' && 'âœ… Available' || 'âŒ None' }} | Files: ${{ steps.check-reports.outputs.artifact_count }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“¤ **Artifact Upload** | âœ… Ready | 2 artifacts uploaded |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“Š Available Reports" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Artifact | Description | How to View |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------------|-------------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŽ­ **playwright-html-report** | Interactive HTML report with screenshots & videos | 1. Download artifact<br>2. Extract ZIP<br>3. Open \`index.html\` in browser |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“¸ **test-artifacts** | Screenshots, videos, traces from failed tests | 1. Download artifact<br>2. Extract to view failed test evidence |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow Run:** [${{ github.workflow }} #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository:** [${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger:** Manual ðŸš€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“ˆ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. **Download artifacts** from the Artifacts section above" >> $GITHUB_STEP_SUMMARY
        echo "2. **Review HTML report** for test results" >> $GITHUB_STEP_SUMMARY
        echo "3. **Check artifacts** for debugging failed tests" >> $GITHUB_STEP_SUMMARY
        echo "4. **Re-run workflow** if needed" >> $GITHUB_STEP_SUMMARY
