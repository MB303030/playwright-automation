name: DOCKER

on:
  workflow_dispatch:  # Manual trigger ONLY

jobs:
  # Check Docker is available
  check-docker:
    runs-on: ubuntu-latest
    outputs:
      docker_available: ${{ steps.check.outputs.available }}
      docker_version: ${{ steps.check.outputs.version }}
    steps:
      - name: ğŸ” Verify Docker installation
        id: check
        run: |
          if command -v docker &> /dev/null; then
            echo "âœ… Docker is available"
            docker --version
            echo "available=true" >> $GITHUB_OUTPUT
            echo "version=$(docker --version | head -n1)" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Docker not found - optional for Playwright"
            echo "available=false" >> $GITHUB_OUTPUT
            echo "version=Not Available" >> $GITHUB_OUTPUT
          fi

  # Run Playwright tests with CI config
  playwright-tests:
    runs-on: ubuntu-latest
    needs: check-docker
    outputs:
      test_status: ${{ steps.run-tests.outputs.status }}
      report_generated: ${{ steps.check-reports.outputs.report_exists }}
      artifacts_count: ${{ steps.check-reports.outputs.artifacts_count }}
    
    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 1: SETUP & DEPENDENCIES
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      id: checkout

    - name: âš™ï¸ Setup Node.js with caching
      uses: actions/setup-node@v4
      id: setup-node
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      id: install-deps
      run: |
        echo "Installing dependencies..."
        npm ci
        echo "âœ… Dependencies installed"

    - name: ğŸ­ Install Playwright browsers
      id: install-browsers
      run: |
        echo "Installing Playwright browsers..."
        npx playwright install --with-deps chromium
        echo "âœ… Browsers installed"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 2: VALIDATION & EXECUTION
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ”§ Environment & file validation
      id: validate-env
      run: |
        echo "=== ğŸ”§ ENVIRONMENT VALIDATION ==="
        echo ""
        echo "ğŸŒ Docker Status: ${{ needs.check-docker.outputs.docker_available == 'true' && 'âœ… Available' || 'âš ï¸ Not Available' }}"
        echo "   Version: ${{ needs.check-docker.outputs.docker_version }}"
        echo ""
        echo "âš™ï¸ Node.js: $(node --version)"
        echo "ğŸ“¦ npm: $(npm --version)"
        echo ""
        echo "ğŸ“ Working directory: $(pwd)"
        echo ""
        echo "ğŸ” Config files:"
        ls -la playwright*.config.js || echo "No config files found"
        echo ""
        echo "ğŸ§ª Test files in tests/:"
        find tests -name "*.spec.js" -o -name "*.test.js" 2>/dev/null | wc -l | xargs echo "Count:"
        echo ""

    - name: ğŸ§ª Run Playwright tests (CI config)
      id: run-tests
      run: |
        echo "=== ğŸ§ª TEST EXECUTION ==="
        echo ""
        echo "Running tests with CI config..."
        echo "Config file: playwright.ci.config.js"
        echo ""
        
        npx playwright test --config=playwright.ci.config.js
        
        # Capture test status
        if [ $? -eq 0 ]; then
          echo "âœ… All tests passed"
          echo "status=passed" >> $GITHUB_OUTPUT
        else
          echo "âŒ Some tests failed"
          echo "status=failed" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 3: REPORT ANALYSIS
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“Š Check generated reports
      id: check-reports
      run: |
        echo "=== ğŸ“Š REPORT ANALYSIS ==="
        echo ""
        
        # Check Playwright HTML report
        if [ -d "playwright-report" ] && [ -f "playwright-report/index.html" ]; then
          REPORT_SIZE=$(du -sh playwright-report | cut -f1)
          echo "âœ… Playwright HTML Report: EXISTS"
          echo "   Size: $REPORT_SIZE"
          echo "   Location: playwright-report/index.html"
          echo "report_exists=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Playwright HTML Report: NOT GENERATED"
          echo "report_exists=false" >> $GITHUB_OUTPUT
        fi
        
        echo ""
        
        # Check test artifacts
        if [ -d "test-results" ]; then
          ARTIFACT_COUNT=$(find test-results -type f | wc -l)
          ARTIFACT_SIZE=$(du -sh test-results | cut -f1)
          echo "âœ… Test Artifacts: EXISTS"
          echo "   Files: $ARTIFACT_COUNT"
          echo "   Size: $ARTIFACT_SIZE"
          echo "   Contains: screenshots, videos, traces"
          echo "artifacts_count=$ARTIFACT_COUNT" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ Test Artifacts: NONE"
          echo "artifacts_count=0" >> $GITHUB_OUTPUT
        fi
        
        echo ""
        echo "ğŸ“ Final directory structure:"
        ls -la

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 4: ARTIFACT UPLOAD
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¤ Upload Playwright HTML report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-html-report
        path: playwright-report/
        retention-days: 7

    - name: ğŸ“¤ Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-artifacts
        path: |
          test-results/
        retention-days: 7

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 5: COMPREHENSIVE SUMMARY
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“‹ Create enhanced job summary
      if: always()
      run: |
        echo "## ğŸ­ Playwright CI - Complete Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸš€ Execution Pipeline" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "```mermaid" >> $GITHUB_STEP_SUMMARY
        echo "graph LR" >> $GITHUB_STEP_SUMMARY
        echo "    subgraph \"ğŸ”µ Preparation\"" >> $GITHUB_STEP_SUMMARY
        echo "        A1[ğŸ” Docker Check] --> A2[ğŸ“¥ Code Checkout] --> A3[âš™ï¸ Node Setup]" >> $GITHUB_STEP_SUMMARY
        echo "        A3 --> A4[ğŸ“¦ Install Deps] --> A5[ğŸ­ Install Browsers]" >> $GITHUB_STEP_SUMMARY
        echo "    end" >> $GITHUB_STEP_SUMMARY
        echo "    subgraph \"ğŸŸ¢ Execution\"" >> $GITHUB_STEP_SUMMARY
        echo "        B1[ğŸ”§ Validate Env] --> B2[ğŸ§ª Run Tests]" >> $GITHUB_STEP_SUMMARY
        echo "    end" >> $GITHUB_STEP_SUMMARY
        echo "    subgraph \"ğŸŸ£ Results\"" >> $GITHUB_STEP_SUMMARY
        echo "        C1[ğŸ“Š Analyze Reports] --> C2[ğŸ“¤ Upload Artifacts]" >> $GITHUB_STEP_SUMMARY
        echo "    end" >> $GITHUB_STEP_SUMMARY
        echo "    A5 --> B1" >> $GITHUB_STEP_SUMMARY
        echo "    B2 --> C1" >> $GITHUB_STEP_SUMMARY
        echo "    style A1 fill:#bbdefb" >> $GITHUB_STEP_SUMMARY
        echo "    style A2 fill:#bbdefb" >> $GITHUB_STEP_SUMMARY
        echo "    style A3 fill:#bbdefb" >> $GITHUB_STEP_SUMMARY
        echo "    style A4 fill:#c8e6c9" >> $GITHUB_STEP_SUMMARY
        echo "    style A5 fill:#c8e6c9" >> $GITHUB_STEP_SUMMARY
        echo "    style B1 fill:#fff9c4" >> $GITHUB_STEP_SUMMARY
        echo "    style B2 fill:#ffcdd2" >> $GITHUB_STEP_SUMMARY
        echo "    style C1 fill:#e1bee7" >> $GITHUB_STEP_SUMMARY
        echo "    style C2 fill:#bbdefb" >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ“Š Phase Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Phase | Step | Status | Details |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|------|--------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| **ğŸ”µ Preparation** | ğŸ” Docker Check | ${{ needs.check-docker.outputs.docker_available == 'true' && 'âœ…' || 'âš ï¸' }} | ${{ needs.check-docker.outputs.docker_version }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **ğŸ”µ Preparation** | ğŸ“¥ Code Checkout | âœ… | Branch: \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **ğŸ”µ Preparation** | âš™ï¸ Node Setup | âœ… | $(node --version) |" >> $GITHUB_STEP_SUMMARY
        echo "| **ğŸ”µ Preparation** | ğŸ“¦ Install Deps | âœ… | Dependencies installed |" >> $GITHUB_STEP_SUMMARY
        echo "| **ğŸ”µ Preparation** | ğŸ­ Install Browsers | âœ… | Chromium with dependencies |" >> $GITHUB_STEP_SUMMARY
        echo "| **ğŸŸ¢ Execution** | ğŸ”§ Validate Env | âœ… | Config & files checked |" >> $GITHUB_STEP_SUMMARY
        echo "| **ğŸŸ¢ Execution** | ğŸ§ª Run Tests | ${{ steps.run-tests.outputs.status == 'passed' && 'âœ…' || 'âŒ' }} | ${{ steps.run-tests.outputs.status }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **ğŸŸ£ Results** | ğŸ“Š Analyze Reports | ${{ steps.check-reports.outputs.report_exists == 'true' && 'âœ…' || 'âŒ' }} | Report: ${{ steps.check-reports.outputs.report_exists == 'true' && 'Generated' || 'Missing' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **ğŸŸ£ Results** | ğŸ“¤ Upload Artifacts | âœ… | 2 artifacts uploaded |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ¯ Available Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Artifact | Type | Content | How to View |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|------|---------|-------------|" >> $GITHUB_STEP_SUMMARY
        echo "| **playwright-html-report** | ğŸ“Š HTML Report | Interactive test report with screenshots & videos | 1. Download artifact<br>2. Extract ZIP<br>3. Open \`index.html\` in browser |" >> $GITHUB_STEP_SUMMARY
        echo "| **test-artifacts** | ğŸ› Debug Files | Screenshots, videos, traces from failed tests | 1. Download artifact<br>2. Extract to view evidence |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ“ˆ Quick Stats" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Status**: ${{ steps.run-tests.outputs.status == 'passed' && 'âœ… All Passed' || 'âŒ Some Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **HTML Report**: ${{ steps.check-reports.outputs.report_exists == 'true' && 'âœ… Generated' || 'âŒ Not Generated' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Debug Artifacts**: ${{ steps.check-reports.outputs.artifacts_count || '0' }} files" >> $GITHUB_STEP_SUMMARY
        echo "- **Docker**: ${{ needs.check-docker.outputs.docker_available == 'true' && 'âœ… Available' || 'âš ï¸ Not Available' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: Manual ğŸš€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ”— Navigation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow Run**: [${{ github.workflow }} #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository**: [${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸš¨ Troubleshooting" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.check-reports.outputs.report_exists }}" = "false" ]; then
          echo "âš ï¸ **No HTML report generated?**" >> $GITHUB_STEP_SUMMARY
          echo "1. Check test execution logs for errors" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify \`playwright.ci.config.js\` has HTML reporter" >> $GITHUB_STEP_SUMMARY
          echo "3. Ensure tests actually ran (check \`test-results/\` folder)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.run-tests.outputs.status }}" = "failed" ]; then
          echo "ğŸ› **Tests failed?**" >> $GITHUB_STEP_SUMMARY
          echo "1. Download \`test-artifacts\` for screenshots/videos" >> $GITHUB_STEP_SUMMARY
          echo "2. Check test execution logs for specific failures" >> $GITHUB_STEP_SUMMARY
          echo "3. Run locally: \`npx playwright test --config=playwright.ci.config.js\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "### ğŸ”„ Re-run Workflow" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "To run tests again:" >> $GITHUB_STEP_SUMMARY
        echo "1. Go to Actions â†’ Playwright CI ON DEMAND" >> $GITHUB_STEP_SUMMARY
        echo "2. Click **Run workflow**" >> $GITHUB_STEP_SUMMARY
        echo "3. Wait for execution (~2-5 minutes)" >> $GITHUB_STEP_SUMMARY
