name: Docker Playwright CI ON DEMAND

on:
  workflow_dispatch:

jobs:
  playwright-tests:
    runs-on: ubuntu-latest
    
    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 1: Environment Setup
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ” Check Docker (Phase 1.1)
      id: check-docker
      run: |
        echo "=== ðŸ” Docker Check ==="
        if command -v docker &> /dev/null; then
          echo "âœ… Docker: $(docker --version)"
          echo "docker_available=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ Docker not found"
          echo "docker_available=false" >> $GITHUB_OUTPUT
        fi

    - name: ðŸ“¥ Checkout code (Phase 1.2)
      uses: actions/checkout@v4
      id: checkout

    - name: âš™ï¸ Setup Node.js (Phase 1.3)
      uses: actions/setup-node@v4
      id: setup-node
      with:
        node-version: '20'
        cache: 'npm'

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 2: Dependencies & Tools
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸŸ© PHASE 2: Dependencies & Tools
      id: phase2
      run: |
        echo "=== ðŸŸ© PHASE 2: Dependencies & Tools ==="
        echo ""
        
        # Show current Node.js version
        echo "ðŸ“¦ Node.js: $(node --version)"
        echo "ðŸ“¦ npm: $(npm --version)"
        
        # Install dependencies
        echo ""
        echo "ðŸ“¦ Installing dependencies..."
        npm ci
        echo "âœ… Dependencies installed"
        
        # Install Playwright browsers
        echo ""
        echo "ðŸŽ­ Installing Playwright browsers..."
        npx playwright install --with-deps chromium
        echo "âœ… Browsers installed"
        
        echo "Phase 2 complete âœ…"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 3: Debug & Validation
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸŸ¨ PHASE 3: Debug & Validation
      id: phase3
      run: |
        echo "=== ðŸŸ¨ PHASE 3: Debug & Validation ==="
        echo ""
        
        echo "ðŸ”§ File structure:"
        echo "Working dir: $(pwd)"
        echo ""
        echo "ðŸ“ Root files:"
        ls -la
        echo ""
        
        echo "âš™ï¸ Configuration:"
        ls -la playwright*.config.js || echo "No config files"
        echo ""
        
        echo "ðŸ§ª Test files:"
        ls -la tests/ 2>/dev/null || echo "No tests directory"
        echo ""
        
        echo "ðŸ“Š Environment summary:"
        echo "- Docker: ${{ steps.check-docker.outputs.docker_available == 'true' && 'Available' || 'Not Available' }}"
        echo "- Node.js: $(node --version)"
        echo "- npm: $(npm --version)"
        echo "- Playwright: $(npx playwright --version 2>/dev/null || echo 'Not found')"
        
        echo "Phase 3 complete âœ…"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 4: Test Execution
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸŸ¥ PHASE 4: Test Execution
      id: phase4
      run: |
        echo "=== ðŸŸ¥ PHASE 4: Test Execution ==="
        echo ""
        echo "ðŸ§ª Running Playwright tests..."
        echo "Using config: playwright.ci.config.js"
        echo ""
        
        npx playwright test --config=playwright.ci.config.js
        
        # Capture exit code
        EXIT_CODE=$?
        echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
        
        if [ $EXIT_CODE -eq 0 ]; then
          echo "âœ… All tests passed"
        else
          echo "âŒ Some tests failed (exit code: $EXIT_CODE)"
        fi
        
        echo "Phase 4 complete âœ…"
      continue-on-error: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 5: Report Analysis
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸŸª PHASE 5: Report Analysis
      id: phase5
      run: |
        echo "=== ðŸŸª PHASE 5: Report Analysis ==="
        echo ""
        
        echo "ðŸ“Š Checking generated artifacts..."
        echo ""
        
        # Check Playwright HTML report
        if [ -d "playwright-report" ] && [ -f "playwright-report/index.html" ]; then
          echo "âœ… Playwright HTML report: EXISTS"
          REPORT_SIZE=$(du -sh playwright-report | cut -f1)
          echo "   Size: $REPORT_SIZE"
          echo "report_exists=true" >> $GITHUB_OUTPUT
          echo "report_size=$REPORT_SIZE" >> $GITHUB_OUTPUT
        else
          echo "âŒ Playwright HTML report: MISSING"
          echo "report_exists=false" >> $GITHUB_OUTPUT
        fi
        
        echo ""
        
        # Check test artifacts
        if [ -d "test-results" ]; then
          ARTIFACT_COUNT=$(find test-results -type f | wc -l)
          ARTIFACT_SIZE=$(du -sh test-results | cut -f1)
          echo "âœ… Test artifacts: EXISTS"
          echo "   Files: $ARTIFACT_COUNT"
          echo "   Size: $ARTIFACT_SIZE"
          echo "artifacts_exist=true" >> $GITHUB_OUTPUT
          echo "artifact_count=$ARTIFACT_COUNT" >> $GITHUB_OUTPUT
        else
          echo "âŒ Test artifacts: MISSING"
          echo "artifacts_exist=false" >> $GITHUB_OUTPUT
        fi
        
        echo "Phase 5 complete âœ…"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 6: Artifact Upload
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸŸ¦ PHASE 6: Artifact Upload
      id: phase6
      run: |
        echo "=== ðŸŸ¦ PHASE 6: Artifact Upload ==="
        echo ""
        
        echo "ðŸ“¤ Uploading artifacts..."
        
        # Upload HTML report if exists
        if [ "${{ steps.phase5.outputs.report_exists }}" = "true" ]; then
          echo "ðŸ“¤ Uploading Playwright HTML report..."
          # This will be done by the upload step below
          echo "âœ… Queued for upload"
        else
          echo "âš ï¸ Skipping HTML report upload (none generated)"
        fi
        
        # Upload test artifacts if exist
        if [ "${{ steps.phase5.outputs.artifacts_exist }}" = "true" ]; then
          echo "ðŸ“¤ Uploading test artifacts..."
          # This will be done by the upload step below
          echo "âœ… Queued for upload"
        else
          echo "âš ï¸ Skipping test artifacts upload (none generated)"
        fi
        
        echo "Phase 6 complete âœ…"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ACTUAL UPLOAD STEPS
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“¤ Upload Playwright HTML report
      if: steps.phase5.outputs.report_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: playwright-html-report
        path: playwright-report/
        retention-days: 7

    - name: ðŸ“¤ Upload test artifacts
      if: steps.phase5.outputs.artifacts_exist == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: test-artifacts
        path: test-results/
        retention-days: 7

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # FINAL SUMMARY
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“‹ Create Horizontal Pipeline Summary
      if: always()
      run: |
        echo "## ðŸŽ­ Docker Playwright CI - Horizontal Pipeline" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“Š Pipeline Visualization" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "```mermaid" >> $GITHUB_STEP_SUMMARY
        echo "graph LR" >> $GITHUB_STEP_SUMMARY
        echo "    subgraph \"ðŸ”µ Phase 1: Environment\"" >> $GITHUB_STEP_SUMMARY
        echo "        A1[ðŸ” Docker Check] --> A2[ðŸ“¥ Code Checkout] --> A3[âš™ï¸ Node Setup]" >> $GITHUB_STEP_SUMMARY
        echo "    end" >> $GITHUB_STEP_SUMMARY
        echo "    " >> $GITHUB_STEP_SUMMARY
        echo "    subgraph \"ðŸŸ¢ Phase 2: Dependencies\"" >> $GITHUB_STEP_SUMMARY
        echo "        B1[ðŸ“¦ npm Install] --> B2[ðŸŽ­ Browser Install]" >> $GITHUB_STEP_SUMMARY
        echo "    end" >> $GITHUB_STEP_SUMMARY
        echo "    " >> $GITHUB_STEP_SUMMARY
        echo "    subgraph \"ðŸŸ¡ Phase 3: Validation\"" >> $GITHUB_STEP_SUMMARY
        echo "        C1[ðŸ”§ File Check] --> C2[âš™ï¸ Config Check] --> C3[ðŸ§ª Test Discovery]" >> $GITHUB_STEP_SUMMARY
        echo "    end" >> $GITHUB_STEP_SUMMARY
        echo "    " >> $GITHUB_STEP_SUMMARY
        echo "    subgraph \"ðŸ”´ Phase 4: Execution\"" >> $GITHUB_STEP_SUMMARY
        echo "        D1[ðŸ§ª Run Tests]" >> $GITHUB_STEP_SUMMARY
        echo "    end" >> $GITHUB_STEP_SUMMARY
        echo "    " >> $GITHUB_STEP_SUMMARY
        echo "    subgraph \"ðŸŸ£ Phase 5: Analysis\"" >> $GITHUB_STEP_SUMMARY
        echo "        E1[ðŸ“Š Check Reports] --> E2[ðŸ“ˆ Count Artifacts]" >> $GITHUB_STEP_SUMMARY
        echo "    end" >> $GITHUB_STEP_SUMMARY
        echo "    " >> $GITHUB_STEP_SUMMARY
        echo "    subgraph \"ðŸ”µ Phase 6: Upload\"" >> $GITHUB_STEP_SUMMARY
        echo "        F1{Report?} -->|Yes| F2[ðŸ“¤ Upload HTML]" >> $GITHUB_STEP_SUMMARY
        echo "        F1 -->|No| F3[âš ï¸ Skip]" >> $GITHUB_STEP_SUMMARY
        echo "        G1{Artifacts?} -->|Yes| G2[ðŸ“¤ Upload Files]" >> $GITHUB_STEP_SUMMARY
        echo "        G1 -->|No| G3[âš ï¸ Skip]" >> $GITHUB_STEP_SUMMARY
        echo "    end" >> $GITHUB_STEP_SUMMARY
        echo "    " >> $GITHUB_STEP_SUMMARY
        echo "    A3 --> B1" >> $GITHUB_STEP_SUMMARY
        echo "    B2 --> C1" >> $GITHUB_STEP_SUMMARY
        echo "    C3 --> D1" >> $GITHUB_STEP_SUMMARY
        echo "    D1 --> E1" >> $GITHUB_STEP_SUMMARY
        echo "    E2 --> F1" >> $GITHUB_STEP_SUMMARY
        echo "    E2 --> G1" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "    style A1 fill:#bbdefb" >> $GITHUB_STEP_SUMMARY
        echo "    style A2 fill:#bbdefb" >> $GITHUB_STEP_SUMMARY
        echo "    style A3 fill:#bbdefb" >> $GITHUB_STEP_SUMMARY
        echo "    style B1 fill:#c8e6c9" >> $GITHUB_STEP_SUMMARY
        echo "    style B2 fill:#c8e6c9" >> $GITHUB_STEP_SUMMARY
        echo "    style C1 fill:#fff9c4" >> $GITHUB_STEP_SUMMARY
        echo "    style C2 fill:#fff9c4" >> $GITHUB_STEP_SUMMARY
        echo "    style C3 fill:#fff9c4" >> $GITHUB_STEP_SUMMARY
        echo "    style D1 fill:#ffcdd2" >> $GITHUB_STEP_SUMMARY
        echo "    style E1 fill:#e1bee7" >> $GITHUB_STEP_SUMMARY
        echo "    style E2 fill:#e1bee7" >> $GITHUB_STEP_SUMMARY
        echo "    style F2 fill:#bbdefb" >> $GITHUB_STEP_SUMMARY
        echo "    style G2 fill:#bbdefb" >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“‹ Phase Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Phase | Color | Status | Key Outputs |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|-------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”µ **1. Environment** | Blue | âœ… | Docker: ${{ steps.check-docker.outputs.docker_available == 'true' && 'âœ…' || 'âš ï¸' }}, Node.js: $(node --version) |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŸ¢ **2. Dependencies** | Green | âœ… | Dependencies installed, Browsers ready |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŸ¡ **3. Validation** | Yellow | âœ… | Config validated, Files checked |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”´ **4. Execution** | Red | ${{ steps.phase4.outcome == 'success' && 'âœ…' || 'âŒ' }} | Exit code: ${{ steps.phase4.outputs.exit_code || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŸ£ **5. Analysis** | Purple | âœ… | Report: ${{ steps.phase5.outputs.report_exists == 'true' && 'âœ…' || 'âŒ' }}, Artifacts: ${{ steps.phase5.outputs.artifact_count || '0' }} files |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”µ **6. Upload** | Blue | ${{ steps.phase5.outputs.report_exists == 'true' && 'âœ…' || 'âš ï¸' }} | HTML: ${{ steps.phase5.outputs.report_exists == 'true' && 'Uploaded' || 'Skipped' }}, Artifacts: ${{ steps.phase5.outputs.artifacts_exist == 'true' && 'Uploaded' || 'Skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸŽ¯ Final Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.phase5.outputs.report_exists }}" = "true" ]; then
          echo "âœ… **COMPLETE SUCCESS**: All phases completed, HTML report available" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¥ Download: **playwright-html-report** (${{ steps.phase5.outputs.report_size }})" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **PARTIAL SUCCESS**: Tests executed but no HTML report" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Check Phase 4 execution logs" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.phase5.outputs.artifacts_exist }}" = "true" ]; then
          echo "- ðŸ› Debug: **test-artifacts** (${{ steps.phase5.outputs.artifact_count }} files)" >> $GITHUB_STEP_SUMMARY
        fi
