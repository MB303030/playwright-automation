name: Docker Playwright CI ON DEMAND

on:
  workflow_dispatch:

jobs:
  playwright-tests:
    runs-on: ubuntu-latest

    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 1: Environment Setup
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ” Check Docker
      id: check-docker
      run: |
        if command -v docker &> /dev/null; then
          echo "Docker available: $(docker --version)"
          echo "docker_available=true" >> $GITHUB_OUTPUT
        else
          echo "Docker NOT found"
          echo "docker_available=false" >> $GITHUB_OUTPUT
        fi

    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 2: Dependencies & Tools
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸŸ© Install Dependencies & Browsers
      run: |
        npm ci
        npx playwright install --with-deps chromium

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 3: Debug & Validation
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸŸ¨ Validate Environment
      run: |
        echo "Current dir: $(pwd)"
        ls -la
        echo "Playwright config:"
        ls -la playwright*.config.js || echo "No config files"
        echo "Test files:"
        ls -la tests/ || echo "No tests directory"
        echo "Node.js: $(node --version)"
        echo "npm: $(npm --version)"
        echo "Docker: ${{ steps.check-docker.outputs.docker_available }}"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 4: Test Execution
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸŸ¥ Run Playwright Tests
      id: run-tests
      run: |
        npx playwright test --config=playwright.ci.config.js
        echo "exit_code=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 5: Report Analysis
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸŸª Analyze Reports
      id: analyze
      run: |
        # Playwright HTML report
        if [ -d "playwright-report" ] && [ -f "playwright-report/index.html" ]; then
          echo "report_exists=true" >> $GITHUB_OUTPUT
          echo "report_size=$(du -sh playwright-report | cut -f1)" >> $GITHUB_OUTPUT
        else
          echo "report_exists=false" >> $GITHUB_OUTPUT
          echo "report_size=0" >> $GITHUB_OUTPUT
        fi

        # Test artifacts
        if [ -d "test-results" ]; then
          echo "artifacts_exist=true" >> $GITHUB_OUTPUT
          echo "artifact_count=$(find test-results -type f | wc -l)" >> $GITHUB_OUTPUT
        else
          echo "artifacts_exist=false" >> $GITHUB_OUTPUT
          echo "artifact_count=0" >> $GITHUB_OUTPUT
        fi

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PHASE 6: Upload Artifacts
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“¤ Upload Playwright HTML Report
      if: steps.analyze.outputs.report_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: playwright-html-report
        path: playwright-report/
        retention-days: 7

    - name: ðŸ“¤ Upload Test Artifacts
      if: steps.analyze.outputs.artifacts_exist == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: test-artifacts
        path: test-results/
        retention-days: 7

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # FINAL SUMMARY
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“‹ Pipeline Summary
      run: |
        echo "## ðŸŽ­ Docker Playwright CI Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Phase | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.check-docker.outputs.docker_available }}" == "true" ]; then
          echo "| Environment | âœ… |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Environment | âš ï¸ |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "| Dependencies | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Validation | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Execution | $([[ ${{ steps.run-tests.outputs.exit_code }} == 0 ]] && echo 'âœ…' || echo 'âŒ') |" >> $GITHUB_STEP_SUMMARY
        echo "| Report | $([[ ${{ steps.analyze.outputs.report_exists }} == 'true' ]] && echo 'âœ…' || echo 'âŒ') |" >> $GITHUB_STEP_SUMMARY
        echo "| Artifacts | $([[ ${{ steps.analyze.outputs.artifacts_exist }} == 'true' ]] && echo 'âœ…' || echo 'âŒ') |" >> $GITHUB_STEP_SUMMARY
        echo ""
        echo "### ðŸ“¥ Download Artifacts"
        echo "- Playwright HTML report: playwright-html-report"
        echo "- Test artifacts: test-artifacts"
