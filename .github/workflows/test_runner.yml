name: Test Runner

on:
  workflow_call:
    inputs:
      test_type:
        required: true
        type: string
      test_suite:
        required: true
        type: string
      browser:
        required: true
        type: string
      environment:
        required: true
        type: string
      custom_tags:
        required: false
        type: string
        default: ''
      priority:
        required: true
        type: string
      test_path:
        required: true
        type: string
      run_id:
        required: true
        type: string

env:
  CI: true

jobs:
  run_tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          if [ -f "package.json" ]; then
            npm ci
          else
            echo "âŒ Error: No package.json found!"
            exit 1
          fi
      
      - name: ğŸ”§ Install Playwright Browsers
        run: |
          echo "ğŸ”§ Installing Playwright browsers..."
          npx playwright install --with-deps
      
      - name: ğŸ§ª Run Playwright Tests
        id: run_playwright
        continue-on-error: true
        run: |
          echo "ğŸš€ Running Playwright tests..."
          echo "ğŸ“‚ Test path: ${{ inputs.test_path }}"
          echo "ğŸŒ Browser: ${{ inputs.browser }}"
          
          # Create output directory for this run
          OUTPUT_DIR="./playwright-report/${{ inputs.run_id }}"
          mkdir -p $OUTPUT_DIR
          
          # Run Playwright with native HTML reporter
          npx playwright test \
            "${{ inputs.test_path }}" \
            --project="${{ inputs.browser }}" \
            --reporter=html,line \
            --output="$OUTPUT_DIR" \
            --retries=1
      
      - name: ğŸ“¦ Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ inputs.run_id }}
          path: ./playwright-report/${{ inputs.run_id }}
          retention-days: 7
      
      - name: ğŸ“¦ Upload Test Results (JSON)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ inputs.run_id }}
          path: ./test-results.json
          retention-days: 7
