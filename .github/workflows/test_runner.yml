name: Test Runner

on:
  workflow_call:
    inputs:
      test_type:
        required: true
        type: string
      test_suite:
        required: true
        type: string
      browser:
        required: true
        type: string
      environment:
        required: true
        type: string
      test_path:
        required: true
        type: string
      run_id:
        required: true
        type: string

env:
  CI: true

jobs:
  debug_and_run_tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ” Debug Received Parameters
        run: |
          echo "=== ðŸŽ¯ PARAMETERS RECEIVED ==="
          echo "Test Type: ${{ inputs.test_type }}"
          echo "Test Suite: ${{ inputs.test_suite }}"
          echo "Browser: ${{ inputs.browser }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "Test Path: ${{ inputs.test_path }}"
          echo "Run ID: ${{ inputs.run_id }}"
          echo "============================="
      
      - name: ðŸ“‚ Verify Test Path Exists
        run: |
          echo "ðŸ” Verifying test path: ${{ inputs.test_path }}"
          
          if [ ! -d "${{ inputs.test_path }}" ] && [ ! -f "${{ inputs.test_path }}" ]; then
            echo "âŒ ERROR: Test path does not exist!"
            echo "Looking for alternatives..."
            
            # Try to find similar paths
            echo "Searching for test directories..."
            find . -type d -name "*test*" -o -name "*spec*" | grep -v node_modules | head -20
            exit 1
          fi
          
          echo "âœ… Test path exists!"
          echo ""
          echo "ðŸ“ Contents of ${{ inputs.test_path }}:"
          ls -la "${{ inputs.test_path }}"
      
      - name: ðŸ“„ List Test Files
        run: |
          echo "=== ðŸ“„ FINDING TEST FILES ==="
          
          # Find all test files in the path
          TEST_FILES=$(find "${{ inputs.test_path }}" -type f \( -name "*.spec.js" -o -name "*.test.js" \) 2>/dev/null || true)
          
          if [ -z "$TEST_FILES" ]; then
            echo "âš ï¸ No .spec.js or .test.js files found"
            echo "Looking for any JavaScript files..."
            find "${{ inputs.test_path }}" -type f -name "*.js" | sort
          else
            echo "Found test files:"
            echo "$TEST_FILES"
            
            # Count and show details
            COUNT=$(echo "$TEST_FILES" | wc -l)
            echo ""
            echo "ðŸ“Š Total test files: $COUNT"
            
            # Show first few lines of each test file
            echo ""
            echo "=== ðŸ“ TEST FILE PREVIEW ==="
            for file in $TEST_FILES; do
              echo ""
              echo "ðŸ“„ $file:"
              echo "---"
              head -5 "$file" | sed 's/^/  /'
              echo "---"
            done
          fi
      
      - name: âš™ï¸ Setup Node.js (Optional - For Running Tests)
        if: false  # Disable for now, just debugging
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ðŸ“¦ Check Package.json (Optional)
        if: false  # Disable for now
        run: |
          echo "Checking package.json..."
          if [ -f "package.json" ]; then
            echo "âœ… package.json exists"
            echo "Dependencies:"
            grep -E '"dependencies"|"devDependencies"' package.json || echo "No dependencies found"
          else
            echo "âŒ No package.json found"
          fi
      
      - name: ðŸŽ¯ SIMULATE Test Run (Debug Only)
        run: |
          echo "=== ðŸ§ª SIMULATED TEST RUN ==="
          echo ""
          echo "This is what WOULD run if we executed tests:"
          echo ""
          echo "npx playwright test \\"
          echo "  \"${{ inputs.test_path }}\" \\"
          echo "  --project=${{ inputs.browser }} \\"
          echo "  --reporter=html,line \\"
          echo "  --output=\"./test-results/${{ inputs.run_id }}\" \\"
          echo "  --retries=1"
          echo ""
          echo "But we're just debugging for now!"
          
          # Create a mock test execution summary
          MOCK_DIR="./mock-results/${{ inputs.run_id }}"
          mkdir -p $MOCK_DIR
          
          echo "{
            \"total\": 5,
            \"passed\": 4,
            \"failed\": 1,
            \"skipped\": 0,
            \"duration\": 12.5,
            \"suites\": [
              {
                \"title\": \"${{ inputs.test_suite }} Tests\",
                \"tests\": [
                  {\"title\": \"Login Test\", \"status\": \"passed\", \"duration\": 2.1},
                  {\"title\": \"Dashboard Test\", \"status\": \"passed\", \"duration\": 1.8},
                  {\"title\": \"Search Test\", \"status\": \"passed\", \"duration\": 3.2},
                  {\"title\": \"Profile Test\", \"status\": \"failed\", \"duration\": 2.4},
                  {\"title\": \"Logout Test\", \"status\": \"passed\", \"duration\": 2.9}
                ]
              }
            ]
          }" > $MOCK_DIR/mock-results.json
          
          echo "âœ… Created mock results in $MOCK_DIR"
      
      - name: ðŸ“¤ Upload Debug Info
        uses: actions/upload-artifact@v4
        with:
          name: debug-info-${{ inputs.run_id }}
          path: |
            mock-results/${{ inputs.run_id }}
          retention-days: 1
