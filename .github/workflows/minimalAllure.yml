playwright-tests:
  runs-on: ubuntu-latest
  needs: check-docker

  steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸŽ­ Install Playwright browsers
      run: npx playwright install --with-deps chromium webkit firefox

    - name: ðŸ§ª Run Playwright tests (CI config)
      run: npx playwright test --config=playwright.ci.config.js
      continue-on-error: true

    - name: ðŸ“¦ Install Allure CLI (required by this action)
      run: |
        sudo apt-get update
        sudo apt-get install -y unzip wget default-jre

    # ðŸŸ¡ Generate the Allure report with history action
    - name: ðŸ“Š Generate Allure Report
      uses: simple-elf/allure-report-action@master
      id: allure_report
      with:
        allure_results: "allure-results"
        allure_report: "allure-report"
        gh_pages: "gh-pages"            # folder to checkout Pages branch (can be empty)
        allure_history: "allure-history" # folder where history is stored

    - name: ðŸ“¤ Upload Allure HTML report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: allure-html-report
        path: allure-report/
        retention-days: 7

    - name: ðŸ“¤ Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-artifacts
        path: |
          test-results/
          screenshots/
          videos/
          traces/
        retention-days: 7

    - name: ðŸ“‹ Job summary
      if: always()
      run: |
        echo "### ðŸ“Š Allure Report" >> $GITHUB_STEP_SUMMARY
        echo "- Download the **Allure HTML Report** artifact" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ§¾ Playwright HTML Report" >> $GITHUB_STEP_SUMMARY
        echo "- Download the **Playwright HTML Report** artifact" >> $GITHUB_STEP_SUMMARY
